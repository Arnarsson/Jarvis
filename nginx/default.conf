# WebSocket upgrade mapping (http-level)
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

upstream frontend {
    server jarvis-frontend:80;
}

upstream backend {
    server jarvis-server:8000;
}

server {
    listen 80;
    server_name jarvis.eureka-ai.cc localhost;

    client_max_body_size 50M;

    # --- Cookie-based auth (remembers for 1 year) ---

    # Login page â€” always public
    location = /auth/login {
        default_type text/html;
        return 200 '<!DOCTYPE html>
<html lang="en">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Jarvis â€” Login</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0a0a;color:#e5e5e5;font-family:-apple-system,system-ui,sans-serif;display:flex;align-items:center;justify-content:center;min-height:100vh}
.card{background:#141414;border:1px solid #262626;border-radius:12px;padding:2.5rem;width:100%;max-width:360px;text-align:center}
h1{font-size:1.5rem;margin-bottom:.5rem}
p{color:#737373;font-size:.875rem;margin-bottom:1.5rem}
input{width:100%;padding:.75rem 1rem;background:#1a1a1a;border:1px solid #333;border-radius:8px;color:#e5e5e5;font-size:1rem;margin-bottom:1rem;outline:none}
input:focus{border-color:#22d3ee}
button{width:100%;padding:.75rem;background:#22d3ee;color:#0a0a0a;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer}
button:hover{background:#06b6d4}
.error{color:#ef4444;font-size:.875rem;margin-bottom:1rem;display:none}
.logo{font-size:2rem;margin-bottom:1rem}
</style></head>
<body>
<div class="card">
<div class="logo">ðŸ§ </div>
<h1>Jarvis</h1>
<p>Authorized personnel only</p>
<div class="error" id="err">Wrong password</div>
<form onsubmit="return doLogin()">
<input type="password" id="pw" placeholder="Password" autofocus>
<button type="submit">Log In</button>
</form>
</div>
<script>
function doLogin(){
  var pw=document.getElementById("pw").value;
  if(pw==="jarvis2026"){
    document.cookie="jarvis_auth=sven2026;path=/;max-age=31536000;SameSite=Lax";
    var r=new URLSearchParams(window.location.search).get("r")||"/";
    window.location.href=r;
  }else{
    document.getElementById("err").style.display="block";
    document.getElementById("pw").value="";
  }
  return false;
}
</script>
</body></html>';
    }

    # Health endpoints â†’ no auth needed for monitoring
    location /health/ {
        proxy_pass http://backend;
        proxy_set_header Host $host;
    }

    # API requests â†’ FastAPI backend (no auth â€” internal/Eureka access needed)
    location /api/ {
        proxy_pass http://backend;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 120s;
    }

    # Captures â†’ FastAPI backend
    location /captures/ {
        proxy_pass http://backend;
        proxy_set_header Host $host;
    }

    # OpenAPI docs â†’ FastAPI backend
    location /docs {
        proxy_pass http://backend;
        proxy_set_header Host $host;
    }

    location /openapi.json {
        proxy_pass http://backend;
        proxy_set_header Host $host;
    }

    # WebSocket support for Vite HMR
    location /ws {
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade    $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host       $host;
        proxy_read_timeout 86400s;
    }

    # Everything else â†’ frontend (SPA) â€” requires cookie
    location / {
        if ($cookie_jarvis_auth != "sven2026") {
            return 302 /auth/login?r=$request_uri;
        }

        proxy_pass http://frontend;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket upgrade support
        proxy_http_version 1.1;
        proxy_set_header Upgrade    $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }
}
