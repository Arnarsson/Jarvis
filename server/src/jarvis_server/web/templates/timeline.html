{% extends "base.html" %}

{% block extra_head %}
<style>
    /* Date picker dropdown */
    .date-picker-dropdown {
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        margin-top: 0.5rem;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        padding: 1rem;
        z-index: 50;
        min-width: 280px;
    }

    .date-picker-day {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: background-color 0.15s;
    }

    .date-picker-day:hover {
        background-color: #f3f4f6;
    }

    .date-picker-day.selected {
        background-color: #eef2ff;
        color: #4f46e5;
    }

    .date-picker-count {
        font-size: 0.75rem;
        color: #9ca3af;
        background-color: #f3f4f6;
        padding: 0.125rem 0.5rem;
        border-radius: 9999px;
    }

    .date-picker-day.selected .date-picker-count {
        background-color: #c7d2fe;
        color: #4338ca;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6" x-data="timelineView()">
    <!-- Page header -->
    <div>
        <h1 class="text-2xl font-bold text-gray-900">Timeline</h1>
        <p class="mt-1 text-sm text-gray-500">Browse your captures chronologically</p>
    </div>

    <!-- Date selector -->
    <div class="flex items-center justify-between rounded-lg bg-white p-4 shadow">
        <button type="button"
                @click="previousDay()"
                :disabled="!hasPreviousDay"
                :class="hasPreviousDay ? 'hover:bg-gray-200' : 'opacity-50 cursor-not-allowed'"
                class="rounded-lg bg-gray-100 px-3 py-2 text-sm font-medium text-gray-700 transition-colors">
            <span class="flex items-center">
                <svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                </svg>
                Previous
            </span>
        </button>

        <div class="relative" x-data="{ open: false }">
            <button @click="open = !open"
                    class="flex items-center space-x-2 rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                </svg>
                <span x-text="formatDisplayDate(selectedDate)"></span>
                <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                </svg>
            </button>

            <!-- Date picker dropdown -->
            <div x-show="open"
                 @click.away="open = false"
                 x-transition:enter="transition ease-out duration-100"
                 x-transition:enter-start="opacity-0 transform scale-95"
                 x-transition:enter-end="opacity-100 transform scale-100"
                 x-transition:leave="transition ease-in duration-75"
                 x-transition:leave-start="opacity-100 transform scale-100"
                 x-transition:leave-end="opacity-0 transform scale-95"
                 class="date-picker-dropdown">
                <div class="mb-2 text-xs font-medium text-gray-500 uppercase tracking-wide">Days with captures</div>
                <div class="max-h-64 overflow-y-auto space-y-1">
                    <template x-for="day in availableDays" :key="day.date">
                        <div @click="selectDate(day.date); open = false"
                             :class="{ 'selected': day.date === selectedDate }"
                             class="date-picker-day">
                            <span x-text="formatDisplayDate(day.date)"></span>
                            <span class="date-picker-count" x-text="day.count + ' captures'"></span>
                        </div>
                    </template>
                    <div x-show="availableDays.length === 0" class="text-sm text-gray-500 text-center py-4">
                        No captures yet
                    </div>
                </div>
            </div>
        </div>

        <button type="button"
                @click="nextDay()"
                :disabled="!hasNextDay"
                :class="hasNextDay ? 'hover:bg-gray-200' : 'opacity-50 cursor-not-allowed'"
                class="rounded-lg bg-gray-100 px-3 py-2 text-sm font-medium text-gray-700 transition-colors">
            <span class="flex items-center">
                Next
                <svg class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                </svg>
            </span>
        </button>
    </div>

    <!-- Summary bar -->
    <div x-show="selectedDate" class="flex items-center justify-between text-sm text-gray-600">
        <span>
            Showing <span class="font-medium" x-text="totalCaptures"></span> captures
            <span x-show="totalCaptures > 0">from <span class="font-medium" x-text="formatDisplayDate(selectedDate)"></span></span>
        </span>
        <span x-show="hasMore" class="text-indigo-600">Scroll for more</span>
    </div>

    <!-- Capture grid -->
    <div class="rounded-lg bg-white shadow">
        <div class="p-6">
            <div id="capture-grid"
                 hx-get=""
                 hx-trigger="load"
                 hx-swap="innerHTML"
                 x-effect="loadCaptures()">
                <!-- Grid loaded via HTMX -->
                <div class="flex items-center justify-center py-12">
                    <svg class="h-8 w-8 animate-spin text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Capture detail modal -->
    <div id="capture-modal"></div>
</div>

<script>
function timelineView() {
    return {
        availableDays: [],
        selectedDate: null,
        currentIndex: 0,
        totalCaptures: 0,
        hasMore: false,
        cursor: null,

        get hasPreviousDay() {
            if (!this.selectedDate || this.availableDays.length === 0) return false;
            const idx = this.availableDays.findIndex(d => d.date === this.selectedDate);
            return idx < this.availableDays.length - 1;
        },

        get hasNextDay() {
            if (!this.selectedDate || this.availableDays.length === 0) return false;
            const idx = this.availableDays.findIndex(d => d.date === this.selectedDate);
            return idx > 0;
        },

        async init() {
            // Load available days
            const response = await fetch('/api/timeline/days?limit=90');
            const days = await response.json();
            this.availableDays = days;

            // Select most recent day with captures
            if (days.length > 0) {
                this.selectDate(days[0].date);
            }
        },

        selectDate(date) {
            this.selectedDate = date;
            this.cursor = null;
            this.loadCaptures();
        },

        previousDay() {
            if (!this.hasPreviousDay) return;
            const idx = this.availableDays.findIndex(d => d.date === this.selectedDate);
            if (idx < this.availableDays.length - 1) {
                this.selectDate(this.availableDays[idx + 1].date);
            }
        },

        nextDay() {
            if (!this.hasNextDay) return;
            const idx = this.availableDays.findIndex(d => d.date === this.selectedDate);
            if (idx > 0) {
                this.selectDate(this.availableDays[idx - 1].date);
            }
        },

        async loadCaptures() {
            if (!this.selectedDate) return;

            let url = `/api/web/timeline/grid?date=${this.selectedDate}`;
            if (this.cursor) {
                url += `&cursor=${encodeURIComponent(this.cursor)}`;
            }

            const self = this;

            // Use HTMX to load content with callback
            htmx.ajax('GET', url, {
                target: '#capture-grid',
                swap: this.cursor ? 'beforeend' : 'innerHTML'
            }).then(() => {
                // Update state from loaded content
                setTimeout(() => {
                    const contentDiv = document.getElementById('capture-grid-content');
                    if (contentDiv) {
                        self.cursor = contentDiv.dataset.nextCursor || null;
                        self.totalCaptures = parseInt(contentDiv.dataset.total || '0');
                        self.hasMore = contentDiv.dataset.hasMore === 'true';
                    }
                }, 50);
            });
        },

        loadMore() {
            if (this.hasMore && this.cursor) {
                this.loadCaptures();
            }
        },

        formatDisplayDate(dateStr) {
            if (!dateStr) return 'Select a date';
            const date = new Date(dateStr + 'T00:00:00');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            if (date.getTime() === today.getTime()) {
                return 'Today';
            } else if (date.getTime() === yesterday.getTime()) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                });
            }
        },

        openCapture(captureId) {
            htmx.ajax('GET', `/api/web/timeline/capture/${captureId}`, {
                target: '#capture-modal',
                swap: 'innerHTML'
            });
        }
    }
}

// Listen for HTMX events to update state
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.id === 'capture-grid') {
        // Extract pagination info from the inner content div
        const contentDiv = document.getElementById('capture-grid-content');
        if (!contentDiv) return;

        const nextCursor = contentDiv.dataset.nextCursor;
        const total = parseInt(contentDiv.dataset.total || '0');
        const hasMore = contentDiv.dataset.hasMore === 'true';

        // Update Alpine state (Alpine.js v3 API)
        const timelineEl = document.querySelector('[x-data]');
        if (timelineEl) {
            const data = Alpine.$data(timelineEl);
            if (data) {
                data.cursor = nextCursor || null;
                data.totalCaptures = total;
                data.hasMore = hasMore;
            }
        }
    }
});

// Infinite scroll observer
document.addEventListener('DOMContentLoaded', function() {
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                // Load more when sentinel is visible (Alpine.js v3 API)
                const timelineEl = document.querySelector('[x-data]');
                if (timelineEl) {
                    const data = Alpine.$data(timelineEl);
                    if (data && data.loadMore) {
                        data.loadMore();
                    }
                }
            }
        });
    }, { threshold: 0.1 });

    // Observe the infinite scroll sentinel when it appears
    const checkSentinel = () => {
        const sentinel = document.getElementById('infinite-scroll-sentinel');
        if (sentinel) {
            observer.observe(sentinel);
        }
    };

    document.body.addEventListener('htmx:afterSwap', checkSentinel);
});
</script>
{% endblock %}
