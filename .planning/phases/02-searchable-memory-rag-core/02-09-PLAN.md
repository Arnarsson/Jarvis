---
phase: 02-searchable-memory-rag-core
plan: 09
type: execute
wave: 3
depends_on: ["02-03", "02-04", "02-05", "02-07", "02-08"]
files_modified:
  - server/docker-compose.yml
  - server/Dockerfile
  - docs/PHASE2-VERIFICATION.md
autonomous: false

must_haves:
  truths:
    - "Docker Compose starts all services including Redis and worker"
    - "OCR pipeline processes captures end-to-end"
    - "Search returns relevant results for queries"
    - "Chat import stores and indexes conversations"
  artifacts:
    - path: "server/docker-compose.yml"
      provides: "Worker service and Redis added"
      contains: "jarvis-worker"
    - path: "docs/PHASE2-VERIFICATION.md"
      provides: "Verification documentation"
  key_links:
    - from: "server/docker-compose.yml"
      to: "server/src/jarvis_server/processing/worker.py"
      via: "arq command"
      pattern: "arq.*WorkerSettings"
---

<objective>
Integrate all Phase 2 components and verify end-to-end functionality.

Purpose: Ensure the complete RAG pipeline works: capture upload -> OCR -> embedding -> search. Verify chat import and timeline browsing.

Output: Updated Docker Compose with worker service, verification documentation, human-verified functionality.
</objective>

<execution_context>
@/home/sven/.claude/get-shit-done/workflows/execute-plan.md
@/home/sven/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-searchable-memory-rag-core/02-RESEARCH.md

# All prior Phase 2 plans
@.planning/phases/02-searchable-memory-rag-core/02-01-PLAN.md
@.planning/phases/02-searchable-memory-rag-core/02-02-PLAN.md
@.planning/phases/02-searchable-memory-rag-core/02-03-PLAN.md
@.planning/phases/02-searchable-memory-rag-core/02-04-PLAN.md
@.planning/phases/02-searchable-memory-rag-core/02-05-PLAN.md
@.planning/phases/02-searchable-memory-rag-core/02-06-PLAN.md
@.planning/phases/02-searchable-memory-rag-core/02-07-PLAN.md
@.planning/phases/02-searchable-memory-rag-core/02-08-PLAN.md

# Docker infrastructure
@server/docker-compose.yml
@server/Dockerfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ARQ worker to Docker Compose</name>
  <files>server/docker-compose.yml</files>
  <action>
Add ARQ worker service to docker-compose.yml.

Add after jarvis-server service:

```yaml
jarvis-worker:
  build:
    context: .
    dockerfile: Dockerfile
  container_name: jarvis-worker
  command: arq jarvis_server.processing.worker.WorkerSettings
  environment:
    - JARVIS_DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-jarvis}:${POSTGRES_PASSWORD:-changeme}@postgres:5432/${POSTGRES_DB:-jarvis}
    - JARVIS_QDRANT_HOST=qdrant
    - JARVIS_QDRANT_PORT=6333
    - JARVIS_REDIS_HOST=redis
    - JARVIS_REDIS_PORT=6379
    - JARVIS_STORAGE_PATH=/data/captures
    - JARVIS_LOG_LEVEL=${JARVIS_LOG_LEVEL:-INFO}
  volumes:
    - captures:/data/captures
    - model_cache:/data/models
  depends_on:
    postgres:
      condition: service_healthy
    qdrant:
      condition: service_started
    redis:
      condition: service_healthy
  networks:
    - jarvis-net
  restart: unless-stopped
  deploy:
    resources:
      limits:
        memory: 4G  # OCR and embedding models are memory-intensive
```

Add model_cache volume:
```yaml
model_cache:
  name: jarvis-model-cache
```

This runs the ARQ worker with:
- Same environment as server (database, qdrant, redis)
- Shared captures volume for image access
- Model cache volume for EasyOCR/FastEmbed models
- Memory limit to prevent OOM from model loading
  </action>
  <verify>
Run `docker compose config` in server/ directory - should validate without errors.
Grep for "jarvis-worker" in docker-compose.yml.
  </verify>
  <done>ARQ worker service added to Docker Compose with model cache volume and memory limits.</done>
</task>

<task type="auto">
  <name>Task 2: Create verification documentation</name>
  <files>docs/PHASE2-VERIFICATION.md</files>
  <action>
Create verification guide for Phase 2 functionality.

**docs/PHASE2-VERIFICATION.md:**
```markdown
# Phase 2: Searchable Memory (RAG Core) - Verification Guide

This guide verifies that the RAG pipeline is working correctly.

## Prerequisites

1. Docker Compose services running:
   ```bash
   cd server
   docker compose up -d
   ```

2. Database migrations applied:
   ```bash
   docker compose exec jarvis-server alembic upgrade head
   ```

3. Qdrant collection initialized (happens on first upload/search)

## Verification Steps

### 1. Service Health

Check all services are healthy:
```bash
docker compose ps
# All should show "healthy" or "running"

# API health
curl http://localhost:8000/health/
# Should return {"status": "healthy", ...}

# Search health
curl http://localhost:8000/api/search/health
# Should return {"status": "healthy", "collection_exists": true}
```

### 2. Capture Upload and Processing

Upload a test screenshot:
```bash
# Create a test image
convert -size 800x600 xc:white -font Helvetica -pointsize 36 \
  -draw "text 50,100 'Hello World - Test Capture'" test.jpg

# Upload
curl -X POST http://localhost:8000/api/captures/ \
  -F "file=@test.jpg;type=image/jpeg" \
  -F "timestamp=$(date -Iseconds)" \
  -F "width=800" \
  -F "height=600"
# Should return capture ID

# Check worker logs for processing
docker compose logs jarvis-worker --tail=20
# Should see "Processed capture ... status: processed"
```

### 3. Search Functionality

Wait ~30 seconds for processing, then search:
```bash
curl -X POST http://localhost:8000/api/search/ \
  -H "Content-Type: application/json" \
  -d '{"query": "Hello World", "limit": 5}'
# Should return results with the test capture
```

### 4. Timeline Browsing

Check timeline API:
```bash
# Get recent captures
curl "http://localhost:8000/api/timeline/?limit=10"
# Should return captures with pagination

# Get day summaries
curl "http://localhost:8000/api/timeline/days?limit=7"
# Should return capture counts per day
```

### 5. Chat Import

Test with a sample ChatGPT export:
```bash
# Create minimal test export
echo '[{"id":"test-1","title":"Test Chat","mapping":{"msg1":{"message":{"author":{"role":"user"},"content":{"content_type":"text","parts":["Hello AI"]},"create_time":1706100000}}}}]' > test_export.json

# Import
curl -X POST http://localhost:8000/api/import/ \
  -F "file=@test_export.json" \
  -F "source=chatgpt"
# Should return {"imported": 1, "skipped": 0, "errors": 0, "source": "chatgpt"}

# Search for imported content
curl -X POST http://localhost:8000/api/search/ \
  -H "Content-Type: application/json" \
  -d '{"query": "Hello AI", "sources": ["chatgpt"], "limit": 5}'
# Should return the imported conversation
```

## Troubleshooting

### Worker Not Processing

```bash
# Check worker status
docker compose logs jarvis-worker --tail=50

# Check Redis connection
docker compose exec redis redis-cli ping
# Should return PONG

# Check job queue
docker compose exec redis redis-cli LLEN arq:queue
# Shows pending jobs
```

### Search Returns No Results

```bash
# Check Qdrant collection
curl http://localhost:6333/collections/captures

# Check collection has points
curl http://localhost:6333/collections/captures/points/count
```

### OCR Not Working

```bash
# Check if models are downloaded
docker compose exec jarvis-worker ls -la /data/models/

# Check EasyOCR logs
docker compose logs jarvis-worker | grep -i easyocr
```

## Success Criteria

- [ ] All Docker services healthy
- [ ] Captures upload and are queued for processing
- [ ] Worker processes captures (OCR + embedding)
- [ ] Search returns relevant results
- [ ] Timeline shows capture history
- [ ] Chat imports are indexed and searchable
```
  </action>
  <verify>
File exists: `ls docs/PHASE2-VERIFICATION.md`
  </verify>
  <done>Verification documentation created with step-by-step testing instructions and troubleshooting guide.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 2 RAG pipeline: OCR processing, hybrid search, chat import, timeline browsing</what-built>
  <how-to-verify>
Follow the verification guide at docs/PHASE2-VERIFICATION.md:

1. Start services: `cd server && docker compose up -d`
2. Apply migrations: `docker compose exec jarvis-server alembic upgrade head`
3. Check health: `curl http://localhost:8000/health/`
4. Upload a test image and verify it gets processed
5. Search for content in the image
6. Test chat import with a sample export
7. Browse timeline API

Expected outcomes:
- All services healthy
- Capture processing shows in worker logs
- Search returns relevant results
- Chat imports are searchable
- Timeline shows captures with pagination
  </how-to-verify>
  <resume-signal>Type "approved" if all verification steps pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Docker config valid: `cd server && docker compose config`
2. Worker service exists: `grep -q "jarvis-worker" server/docker-compose.yml`
3. Docs exist: `ls docs/PHASE2-VERIFICATION.md`
</verification>

<success_criteria>
- Docker Compose includes jarvis-worker service
- Worker uses arq command with WorkerSettings
- Model cache volume added for persistence
- Memory limit set for worker (4G)
- Verification documentation guides testing
- Human verification confirms end-to-end functionality
</success_criteria>

<output>
After completion, create `.planning/phases/02-searchable-memory-rag-core/02-09-SUMMARY.md`
</output>
