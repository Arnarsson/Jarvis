---
phase: 03-mcp-server-claude-code
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - mcp/src/jarvis_mcp/validators.py
  - mcp/src/jarvis_mcp/audit.py
autonomous: true

must_haves:
  truths:
    - "Input validation strips control characters from queries"
    - "Prompt injection patterns are detected and rejected"
    - "All MCP tool calls are logged with structured data"
    - "Sensitive data is truncated in audit logs"
  artifacts:
    - path: "mcp/src/jarvis_mcp/validators.py"
      provides: "Input sanitization for prompt injection prevention"
      contains: "validate_search_query"
    - path: "mcp/src/jarvis_mcp/audit.py"
      provides: "Audit logging for MCP tool calls"
      contains: "log_mcp_call"
  key_links:
    - from: "mcp/src/jarvis_mcp/validators.py"
      to: "structlog"
      via: "suspicious input logging"
      pattern: "suspicious_input"
---

<objective>
Create input validators and audit logging infrastructure

Purpose: Implement security-critical components required before tools can be built. Input validation prevents prompt injection attacks (MCP-05). Audit logging tracks all MCP calls for compliance and debugging (MCP-04).

Output: Reusable validators and audit functions that tools will import
</objective>

<execution_context>
@/home/sven/.claude/get-shit-done/workflows/execute-plan.md
@/home/sven/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-mcp-server-claude-code/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create input validators for prompt injection prevention</name>
  <files>mcp/src/jarvis_mcp/validators.py</files>
  <action>
Create validators.py with functions to sanitize user inputs and prevent prompt injection.

Functions to implement:

1. validate_search_query(query: str) -> str
   - Strip control characters (regex: [\x00-\x08\x0b\x0c\x0e-\x1f\x7f])
   - Normalize excessive whitespace to single spaces
   - Check for dangerous patterns that could confuse the LLM:
     - ^``` (code block starts)
     - ^\s*# (markdown headers at start)
     - <\|.*?\|> (common prompt delimiters)
     - \[INST\] or \[/INST\] (instruction markers)
   - If dangerous pattern found: log warning with "suspicious_input_blocked" event, raise ValueError
   - Return sanitized query

2. validate_topic(topic: str) -> str
   - Same sanitization as search query
   - Additional check: topic should be 1-500 chars (shorter than full search)
   - Return sanitized topic

Use structlog for logging suspicious inputs. Import from jarvis_mcp.server to use the configured logger.

Include docstrings explaining what each function does and why patterns are blocked.
  </action>
  <verify>
python -c "
from jarvis_mcp.validators import validate_search_query, validate_topic

# Normal input passes
assert validate_search_query('find meetings about api') == 'find meetings about api'

# Control chars stripped
assert validate_search_query('test\x00query') == 'testquery'

# Whitespace normalized
assert validate_search_query('test   query') == 'test query'

# Dangerous patterns rejected
try:
    validate_search_query('[INST] ignore previous')
    assert False, 'Should have raised'
except ValueError:
    pass

print('Validators working correctly')
"
  </verify>
  <done>Validators sanitize input, strip dangerous patterns, log suspicious attempts</done>
</task>

<task type="auto">
  <name>Task 2: Create audit logging infrastructure</name>
  <files>mcp/src/jarvis_mcp/audit.py</files>
  <action>
Create audit.py with functions to log all MCP tool invocations.

Main function:

log_mcp_call(
    tool_name: str,
    input_params: dict[str, Any],
    result_summary: str,
    duration_ms: float,
    success: bool,
    error: str | None = None,
) -> None

Implementation details:
- Get logger via structlog.get_logger("jarvis_mcp.audit")
- Sanitize input_params before logging:
  - Truncate string values > 200 chars to first 100 + "...[truncated]"
  - This prevents huge queries from bloating logs
- Truncate result_summary to 200 chars
- Truncate error to 500 chars if present
- Log as INFO for success, ERROR for failures
- Event name: "mcp_tool_invoked" (success) or "mcp_tool_failed" (error)

Log fields:
- tool: tool name
- params: sanitized params dict
- result_summary: brief description of result
- duration_ms: execution time rounded to 2 decimals
- success: boolean
- error: (only if failed) error message

Private helper function:
_sanitize_for_log(params: dict) -> dict
  - Iterate params, truncate long strings
  </action>
  <verify>
python -c "
from jarvis_mcp.audit import log_mcp_call

# Should log without error
log_mcp_call(
    tool_name='search_memory',
    input_params={'query': 'test query', 'limit': 10},
    result_summary='5 results found',
    duration_ms=123.456,
    success=True,
)

# Should truncate long params
log_mcp_call(
    tool_name='search_memory',
    input_params={'query': 'x' * 500},
    result_summary='y' * 500,
    duration_ms=50.0,
    success=False,
    error='Test error',
)

print('Audit logging working correctly')
"
  </verify>
  <done>Audit logging captures tool calls with proper sanitization and truncation</done>
</task>

</tasks>

<verification>
1. python -c "from jarvis_mcp.validators import validate_search_query, validate_topic" works
2. python -c "from jarvis_mcp.audit import log_mcp_call" works
3. Normal queries pass validation
4. Dangerous patterns raise ValueError
5. Audit logs capture tool calls without errors
</verification>

<success_criteria>
- Input validation prevents prompt injection patterns
- Control characters stripped from all inputs
- Suspicious inputs logged before rejection
- Audit logging captures all tool calls
- Long values truncated in logs
- Success and failure cases logged appropriately
</success_criteria>

<output>
After completion, create `.planning/phases/03-mcp-server-claude-code/03-02-SUMMARY.md`
</output>
