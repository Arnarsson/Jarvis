---
phase: 03-mcp-server-claude-code
plan: 05
type: execute
wave: 3
depends_on: [03-03, 03-04]
files_modified:
  - mcp/tests/test_validators.py
  - mcp/tests/test_tools.py
autonomous: false

must_haves:
  truths:
    - "Unit tests verify input validation blocks dangerous patterns"
    - "Unit tests verify audit logging captures tool calls"
    - "Integration test shows tools registered and callable"
    - "Claude Code can connect to MCP server via stdio"
    - "Tools appear in Claude Code tool list"
  artifacts:
    - path: "mcp/tests/test_validators.py"
      provides: "Unit tests for input validation"
      contains: "def test_"
    - path: "mcp/tests/test_tools.py"
      provides: "Unit tests for MCP tools"
      contains: "def test_"
  key_links:
    - from: "Claude Code"
      to: "mcp/src/jarvis_mcp/server.py"
      via: "stdio transport"
      pattern: "python -m jarvis_mcp.server"

user_setup:
  - service: claude-code
    why: "Connect MCP server to Claude Code"
    dashboard_config:
      - task: "Add jarvis-memory MCP server"
        command: "claude mcp add --transport stdio --scope local jarvis-memory -- python -m jarvis_mcp.server"
---

<objective>
Integration testing and Claude Code configuration

Purpose: Verify the complete MCP server works end-to-end with unit tests for validators, integration test for tools, and manual verification that Claude Code can connect and see the tools.

Output: Passing tests and working Claude Code integration
</objective>

<execution_context>
@/home/sven/.claude/get-shit-done/workflows/execute-plan.md
@/home/sven/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-mcp-server-claude-code/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unit tests for validators and tools</name>
  <files>
    mcp/tests/__init__.py
    mcp/tests/test_validators.py
    mcp/tests/test_tools.py
  </files>
  <action>
Create the tests/ directory with comprehensive unit tests.

mcp/tests/__init__.py:
- Empty file (package marker)

mcp/tests/test_validators.py:
Test validate_search_query():
- test_valid_query_passes: Normal text passes unchanged
- test_strips_control_characters: \x00, \x1f etc removed
- test_normalizes_whitespace: Multiple spaces become single space
- test_blocks_code_block_start: ^``` at start raises ValueError
- test_blocks_markdown_header_start: ^\s*# at start raises ValueError
- test_blocks_prompt_delimiters: <|...|> patterns raise ValueError
- test_blocks_instruction_markers: [INST] and [/INST] raise ValueError
- test_allows_safe_brackets: Normal text with [] is fine
- test_allows_code_in_middle: ``` in middle of text is fine (only blocks at start)

Test validate_topic():
- test_valid_topic_passes: Normal topic passes
- test_topic_length_limit: Long topic (>500 chars) should work with search query validation

mcp/tests/test_tools.py:
Test tool registration:
- test_search_memory_registered: Tool in mcp.list_tools()
- test_catch_me_up_registered: Tool in mcp.list_tools()
- test_search_memory_has_parameters: Check tool schema has query, limit, sources
- test_catch_me_up_has_parameters: Check tool schema has topic, days

Use pytest for all tests. Add pytest to dev dependencies if not present.
  </action>
  <verify>
cd /home/sven/Documents/jarvis/mcp && pip install pytest && python -m pytest tests/ -v
  </verify>
  <done>All unit tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Create Claude Code MCP configuration script</name>
  <files>mcp/scripts/setup-claude-code.sh</files>
  <action>
Create a helper script that configures Claude Code to use the MCP server.

mcp/scripts/setup-claude-code.sh:

#!/bin/bash
# Setup jarvis-memory MCP server in Claude Code
#
# Prerequisites:
# - Claude Code CLI installed (code.claude.com)
# - jarvis-mcp package installed: pip install -e mcp/
# - Jarvis server running at http://127.0.0.1:8000

set -e

echo "Configuring jarvis-memory MCP server for Claude Code..."

# Get the project root (parent of mcp/)
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Add MCP server to Claude Code (local scope = only this workspace)
claude mcp add --transport stdio --scope local \
  --env JARVIS_API_URL=http://127.0.0.1:8000 \
  jarvis-memory -- python -m jarvis_mcp.server

echo ""
echo "Configuration complete!"
echo ""
echo "Verify with: claude mcp list"
echo "You should see 'jarvis-memory' in the list"
echo ""
echo "To test, start a new Claude Code session and try:"
echo "  - Use the search_memory tool to find something"
echo "  - Use the catch_me_up tool for context recovery"

Make the script executable in the action.
  </action>
  <verify>
test -x /home/sven/Documents/jarvis/mcp/scripts/setup-claude-code.sh && echo "Script is executable"
  </verify>
  <done>Setup script created and executable</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete MCP server with search_memory and catch_me_up tools:
- Input validation prevents prompt injection
- Audit logging tracks all tool calls
- Tools call existing Jarvis search API
- Server runs with stdio transport for Claude Code
  </what-built>
  <how-to-verify>
1. Ensure Jarvis server is running:
   ```
   docker compose -f server/docker-compose.yml up -d
   ```

2. Run the setup script to add MCP to Claude Code:
   ```
   cd /home/sven/Documents/jarvis
   ./mcp/scripts/setup-claude-code.sh
   ```

3. Verify MCP server is listed:
   ```
   claude mcp list
   ```
   Should show "jarvis-memory" with stdio transport

4. Start a NEW Claude Code session and verify tools appear:
   - You should see search_memory and catch_me_up in available tools
   - Try: "Use search_memory to find any screen captures"
   - Try: "Use catch_me_up for project jarvis from last 7 days"

5. Check audit logs (in server stderr):
   - Should see "mcp_tool_invoked" events for each tool call
  </how-to-verify>
  <resume-signal>Type "approved" if tools work in Claude Code, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. All unit tests pass: pytest tests/ -v
2. Script is executable
3. Claude Code can connect to MCP server
4. Tools appear in Claude Code
5. Tools function correctly (search returns results, catch_me_up groups by date)
6. Audit logs show tool invocations
</verification>

<success_criteria>
- Unit tests cover validation edge cases
- Unit tests verify tool registration
- Setup script configures Claude Code correctly
- MCP server appears in `claude mcp list`
- search_memory tool accessible and functional in Claude Code
- catch_me_up tool accessible and functional in Claude Code
- All MCP calls logged in audit trail
</success_criteria>

<output>
After completion, create `.planning/phases/03-mcp-server-claude-code/03-05-SUMMARY.md`
</output>
