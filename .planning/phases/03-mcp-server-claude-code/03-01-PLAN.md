---
phase: 03-mcp-server-claude-code
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - mcp/pyproject.toml
  - mcp/src/jarvis_mcp/__init__.py
  - mcp/src/jarvis_mcp/server.py
  - mcp/src/jarvis_mcp/client.py
autonomous: true

must_haves:
  truths:
    - "MCP package can be installed with pip install -e mcp/"
    - "python -m jarvis_mcp.server starts without error"
    - "FastMCP server instance is created with name jarvis-memory"
  artifacts:
    - path: "mcp/pyproject.toml"
      provides: "Package configuration with mcp[cli] dependency"
      contains: "mcp[cli]"
    - path: "mcp/src/jarvis_mcp/server.py"
      provides: "FastMCP server with stdio transport"
      contains: "FastMCP"
    - path: "mcp/src/jarvis_mcp/client.py"
      provides: "Async HTTP client for server API"
      contains: "httpx.AsyncClient"
  key_links:
    - from: "mcp/src/jarvis_mcp/server.py"
      to: "structlog"
      via: "stderr-only logging"
      pattern: "file=sys.stderr"
---

<objective>
Create MCP package foundation with FastMCP server skeleton

Purpose: Establish the MCP package structure with proper dependency management, HTTP client for server API calls, and FastMCP server skeleton that can run with stdio transport without stdout pollution.

Output: Installable Python package at mcp/ with working server entry point
</objective>

<execution_context>
@/home/sven/.claude/get-shit-done/workflows/execute-plan.md
@/home/sven/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-mcp-server-claude-code/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MCP package with pyproject.toml</name>
  <files>
    mcp/pyproject.toml
    mcp/src/jarvis_mcp/__init__.py
  </files>
  <action>
Create the mcp/ directory structure following the research recommendations:

mcp/
  pyproject.toml
  src/
    jarvis_mcp/
      __init__.py

pyproject.toml should include:
- name: jarvis-mcp
- version: 0.1.0
- Python requires >=3.10
- Dependencies:
  - "mcp[cli]>=1.26.0,<2" (pin to v1.x for stability)
  - httpx>=0.27 (async HTTP client)
  - structlog>=24.0 (audit logging, consistent with server)
  - pydantic>=2.0 (validation, already used by FastMCP)
- Hatchling build backend (consistent with agent/server packages)
- Entry point: jarvis-mcp = "jarvis_mcp.server:main"

__init__.py should expose __version__ = "0.1.0"
  </action>
  <verify>
cd /home/sven/Documents/jarvis && pip install -e mcp/ && python -c "import jarvis_mcp; print(jarvis_mcp.__version__)"
  </verify>
  <done>Package installs successfully and version is accessible</done>
</task>

<task type="auto">
  <name>Task 2: Create HTTP client for server API</name>
  <files>mcp/src/jarvis_mcp/client.py</files>
  <action>
Create async HTTP client module for calling the Jarvis server search API.

Key implementation details:
- Use httpx.AsyncClient with connection pooling
- Base URL from JARVIS_API_URL env var (default http://127.0.0.1:8000)
- Timeout of 25 seconds (leave margin for MCP timeout)
- Lazy client initialization (create on first use)
- get_client() function returns singleton AsyncClient
- Include Content-Type: application/json header

The client will be used by tools to call:
- POST /api/search/ for search_memory
- (same endpoint with date filters for catch_me_up)
  </action>
  <verify>
python -c "from jarvis_mcp.client import get_client; import asyncio; asyncio.run(get_client())"
  </verify>
  <done>Client module imports and creates httpx.AsyncClient without error</done>
</task>

<task type="auto">
  <name>Task 3: Create FastMCP server skeleton</name>
  <files>mcp/src/jarvis_mcp/server.py</files>
  <action>
Create the MCP server entry point using FastMCP.

CRITICAL: Configure structlog to write ONLY to stderr BEFORE any imports that might log. This is essential for stdio transport - any stdout output breaks the JSON-RPC protocol.

Implementation:
1. Configure structlog at module top:
   - processors: add_log_level, TimeStamper(fmt="iso"), JSONRenderer()
   - logger_factory: PrintLoggerFactory(file=sys.stderr)
2. Create FastMCP instance:
   - name="jarvis-memory"
   - mask_error_details=True (security: don't expose internal errors)
3. Create main() function:
   - Log server starting
   - Call mcp.run(transport="stdio")
4. if __name__ == "__main__": main()

Do NOT register any tools yet - that will be done in later plans after validators/audit are ready. The server should start cleanly even with no tools (tools are registered via imports in later plans).
  </action>
  <verify>
timeout 2 python -m jarvis_mcp.server 2>&1 || true
# Should see "mcp_server_starting" in stderr output, then exit on stdin close
  </verify>
  <done>Server starts with stdio transport, logs to stderr only, exits cleanly when stdin closes</done>
</task>

</tasks>

<verification>
1. pip install -e mcp/ succeeds
2. python -c "import jarvis_mcp" works
3. python -c "from jarvis_mcp.client import get_client" works
4. python -c "from jarvis_mcp.server import mcp" works
5. Server can start: timeout 2 python -m jarvis_mcp.server 2>&1
</verification>

<success_criteria>
- MCP package installable with pip
- HTTP client ready for API calls
- FastMCP server starts with stdio transport
- No stdout pollution (logging to stderr only)
- mask_error_details enabled for security
</success_criteria>

<output>
After completion, create `.planning/phases/03-mcp-server-claude-code/03-01-SUMMARY.md`
</output>
