---
phase: 06-workflow-automation
plan: 05
type: execute
wave: 3
depends_on: [06-01, 06-02, 06-03, 06-04]
autonomous: true
---

<objective>
Implement safety guardrails: destructive action blocking, false positive tracking, undo capability (AUTO-05, AUTO-06, AUTO-07).
</objective>

<context>
@server/src/jarvis_server/workflow/executor.py
@.planning/REQUIREMENTS.md (AUTO-05, AUTO-06, AUTO-07)
</context>

<tasks>

<task type="auto">
<name>Task 1: Create safety classifier</name>
<files>server/src/jarvis_server/workflow/safety.py</files>
<action>
SafetyClassifier that assesses action risk:
- classify_action(action) -> SafetyLevel (safe|caution|destructive)
- is_destructive(action) -> bool

Destructive actions (always require approval):
- DELETE_*, REMOVE_*, DROP_*
- SEND_EMAIL (could be spam)
- FINANCIAL_* (payments, transfers)
- SYSTEM_* (shutdown, reboot)
- Any action with external side effects

Caution actions (require confirmation on first use):
- MODIFY_*, UPDATE_*
- CREATE_* (could create spam)
- API calls to external services
</action>
<done>Classifier created</done>
</task>

<task type="auto">
<name>Task 2: Create false positive tracker</name>
<files>server/src/jarvis_server/workflow/false_positive.py</files>
<action>
FalsePositiveTracker:
- record_feedback(execution_id, was_correct: bool)
- get_accuracy(pattern_id) -> float
- check_suspension(pattern_id) -> bool

Rules:
- If accuracy < 80% over last 10 executions: suspend
- Suspended patterns return to "observe" tier
- User notified when pattern suspended
</action>
<done>Tracker created</done>
</task>

<task type="auto">
<name>Task 3: Create undo manager</name>
<files>server/src/jarvis_server/workflow/undo.py</files>
<action>
UndoManager for reversing actions:
- can_undo(execution_id) -> bool
- undo(execution_id) -> UndoResult
- get_undo_deadline(execution_id) -> datetime

Undo strategies per action type:
- NOTIFY: No undo needed
- OPEN_APP: Close app
- TYPE_TEXT: Clear typed text
- CREATE_*: Delete created item
- File operations: Restore from backup

Store undo state for 24 hours, then cleanup.
</action>
<done>Undo manager created</done>
</task>

<task type="auto">
<name>Task 4: Add feedback API</name>
<files>server/src/jarvis_server/api/workflow.py</files>
<action>
Add feedback endpoints:
- POST /api/workflow/executions/{id}/feedback - Was this correct? (thumbs up/down)
- GET /api/workflow/patterns/{id}/accuracy - Pattern accuracy stats
- POST /api/workflow/patterns/{id}/unsuspend - Manually reactivate
</action>
<done>Feedback API added</done>
</task>

<task type="auto">
<name>Task 5: Integrate guardrails with executor</name>
<files>server/src/jarvis_server/workflow/executor.py</files>
<action>
Before execution:
1. Check if pattern is suspended
2. Classify action safety level
3. Block destructive actions without approval
4. Record execution for undo

After execution:
1. Store undo state
2. Schedule undo cleanup after 24h
</action>
<done>Guardrails integrated</done>
</task>

</tasks>

<verification>
- Destructive actions are blocked
- False positives trigger suspension
- Undo works within 24 hour window
</verification>

<success_criteria>
- Cannot auto-execute destructive actions
- Patterns suspend at < 80% accuracy
- User can undo any action for 24 hours
</success_criteria>

<commit_guidance>
feat(06-05): add safety guardrails for workflow automation
</commit_guidance>
