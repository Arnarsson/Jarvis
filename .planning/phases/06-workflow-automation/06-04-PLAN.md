---
phase: 06-workflow-automation
plan: 04
type: execute
wave: 2
depends_on: [06-01, 06-02, 06-03]
autonomous: true
---

<objective>
Build workflow execution engine for approved automations (AUTO-03).
</objective>

<context>
@server/src/jarvis_server/workflow/repository.py
@.planning/REQUIREMENTS.md (AUTO-03, AUTO-05)
</context>

<tasks>

<task type="auto">
<name>Task 1: Create execution engine</name>
<files>server/src/jarvis_server/workflow/executor.py</files>
<action>
WorkflowExecutor that runs approved automations:
- execute_workflow(pattern_id, trigger_capture_id) -> ExecutionResult
- Supports action types:
  - NOTIFY: Send notification (always safe)
  - OPEN_APP: Open application
  - OPEN_URL: Open URL in browser
  - TYPE_TEXT: Type predefined text
  - RUN_SCRIPT: Execute approved script
  - SEND_MESSAGE: Send via configured channel

Execution flow:
1. Validate pattern is in "auto" tier (or "suggest" with pending approval)
2. Check safety constraints
3. Execute actions
4. Record result
5. Set undo window
</action>
<done>Executor created</done>
</task>

<task type="auto">
<name>Task 2: Create action handlers</name>
<files>server/src/jarvis_server/workflow/actions.py</files>
<action>
Individual action handlers:
- NotifyAction: Desktop/mobile notification
- OpenAppAction: Launch application
- OpenUrlAction: Open URL
- TypeTextAction: Simulate typing
- ScriptAction: Run shell script (sandboxed)

Each handler:
- validate(params) -> bool
- execute(params) -> ActionResult
- undo(execution_id) -> bool (if reversible)
</action>
<done>Handlers created</done>
</task>

<task type="auto">
<name>Task 3: Create execution queue</name>
<files>server/src/jarvis_server/workflow/queue.py</files>
<action>
ARQ task for workflow execution:
- Queue execution when pattern triggers
- Handle retries with backoff
- Respect rate limits (max executions per hour)
</action>
<done>Queue integration added</done>
</task>

<task type="auto">
<name>Task 4: Add execution API</name>
<files>server/src/jarvis_server/api/workflow.py</files>
<action>
Add to workflow API:
- POST /api/workflow/execute/{pattern_id} - Manually trigger
- GET /api/workflow/executions - List recent executions
- GET /api/workflow/executions/{id} - Execution details
- POST /api/workflow/executions/{id}/undo - Undo if within window
</action>
<done>Execution API added</done>
</task>

</tasks>

<verification>
- Execution runs for auto-tier patterns
- Actions execute correctly
- Undo works within time window
</verification>

<success_criteria>
- Automations execute when triggered
- Results are logged with full context
- Undo available for 24 hours
</success_criteria>

<commit_guidance>
feat(06-04): add workflow execution engine
</commit_guidance>
