---
phase: 04-calendar-meeting-intelligence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/jarvis_server/calendar/__init__.py
  - server/src/jarvis_server/calendar/oauth.py
  - server/src/jarvis_server/calendar/models.py
  - server/src/jarvis_server/db/models.py
  - server/src/jarvis_server/api/calendar.py
autonomous: true

must_haves:
  truths:
    - "User can initiate Google Calendar OAuth flow from API endpoint"
    - "OAuth tokens are stored securely and can be refreshed"
    - "CalendarEvent and Meeting models exist in database"
  artifacts:
    - path: "server/src/jarvis_server/calendar/oauth.py"
      provides: "OAuth2 flow with token persistence"
      contains: "InstalledAppFlow"
    - path: "server/src/jarvis_server/calendar/models.py"
      provides: "CalendarEvent and Meeting SQLAlchemy models"
      contains: "class CalendarEvent"
    - path: "server/src/jarvis_server/api/calendar.py"
      provides: "OAuth initiation and callback endpoints"
      contains: "@router.get"
  key_links:
    - from: "server/src/jarvis_server/calendar/oauth.py"
      to: "google-auth-oauthlib"
      via: "InstalledAppFlow import"
      pattern: "from google_auth_oauthlib.flow import InstalledAppFlow"
    - from: "server/src/jarvis_server/api/calendar.py"
      to: "server/src/jarvis_server/calendar/oauth.py"
      via: "get_calendar_service import"
      pattern: "from.*calendar.oauth.*import"
---

<objective>
Create Google Calendar OAuth foundation and database schema for calendar events and meetings

Purpose: Establish the authentication infrastructure for Google Calendar API access and the database models needed to store calendar events and meeting records. This is the foundation for all calendar and meeting intelligence features.

Output: Working OAuth flow, CalendarEvent and Meeting database models, API endpoints for auth
</objective>

<execution_context>
@/home/sven/.claude/get-shit-done/workflows/execute-plan.md
@/home/sven/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-calendar-meeting-intelligence/04-RESEARCH.md
@server/src/jarvis_server/db/models.py
@server/src/jarvis_server/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Google Calendar dependencies to server</name>
  <files>server/pyproject.toml</files>
  <action>
Add Google API client dependencies to server/pyproject.toml:

dependencies = [
  # ... existing deps ...
  "google-api-python-client>=2.187.0",
  "google-auth-oauthlib>=1.2.0",
  "google-auth>=2.30.0",
]

These are the official Google libraries for Calendar API access with OAuth2.
  </action>
  <verify>
cd /home/sven/Documents/jarvis && pip install -e server/ && python -c "from google_auth_oauthlib.flow import InstalledAppFlow; print('Google OAuth installed')"
  </verify>
  <done>Google API dependencies installed and importable</done>
</task>

<task type="auto">
  <name>Task 2: Create calendar models (CalendarEvent, Meeting, SyncState)</name>
  <files>
    server/src/jarvis_server/calendar/__init__.py
    server/src/jarvis_server/calendar/models.py
  </files>
  <action>
Create server/src/jarvis_server/calendar/ directory with models.

calendar/__init__.py: Empty package marker

calendar/models.py: SQLAlchemy models for calendar data

class SyncState(Base):
    """Stores sync tokens for incremental calendar sync."""
    __tablename__ = "sync_states"

    id: Mapped[str] = mapped_column(String(50), primary_key=True)  # e.g., "calendar_primary"
    token: Mapped[str] = mapped_column(String(500), nullable=False)
    updated_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now())

class CalendarEvent(Base):
    """Google Calendar event synced to Jarvis."""
    __tablename__ = "calendar_events"

    id: Mapped[str] = mapped_column(String(36), primary_key=True, default=lambda: str(uuid4()))
    google_event_id: Mapped[str] = mapped_column(String(100), unique=True, nullable=False)
    calendar_id: Mapped[str] = mapped_column(String(200), default="primary")

    # Event details
    summary: Mapped[str] = mapped_column(String(500), nullable=False)
    description: Mapped[str | None] = mapped_column(Text, nullable=True)
    location: Mapped[str | None] = mapped_column(String(500), nullable=True)

    # Timing
    start_time: Mapped[datetime] = mapped_column(DateTime(timezone=True), nullable=False)
    end_time: Mapped[datetime] = mapped_column(DateTime(timezone=True), nullable=False)
    all_day: Mapped[bool] = mapped_column(default=False)

    # Attendees stored as JSON string
    attendees_json: Mapped[str | None] = mapped_column(Text, nullable=True)

    # Meeting link (Google Meet, Zoom, etc.)
    meeting_link: Mapped[str | None] = mapped_column(String(500), nullable=True)

    # Status: confirmed, tentative, cancelled
    status: Mapped[str] = mapped_column(String(20), default="confirmed")

    # Sync metadata
    etag: Mapped[str | None] = mapped_column(String(100), nullable=True)
    synced_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), server_default=func.now())

    __table_args__ = (
        Index("ix_calendar_events_start", "start_time"),
        Index("ix_calendar_events_google_id", "google_event_id"),
    )

class Meeting(Base):
    """Meeting instance with optional recording/transcription."""
    __tablename__ = "meetings"

    id: Mapped[str] = mapped_column(String(36), primary_key=True, default=lambda: str(uuid4()))
    calendar_event_id: Mapped[str | None] = mapped_column(String(36), nullable=True)  # FK to CalendarEvent

    # Detection info
    platform: Mapped[str | None] = mapped_column(String(50), nullable=True)  # zoom, google_meet, teams
    detected_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), nullable=False)
    ended_at: Mapped[datetime | None] = mapped_column(DateTime(timezone=True), nullable=True)

    # Recording (if consent given)
    audio_path: Mapped[str | None] = mapped_column(String(500), nullable=True)
    consent_given: Mapped[bool] = mapped_column(default=False)

    # Transcription
    transcript: Mapped[str | None] = mapped_column(Text, nullable=True)
    transcript_status: Mapped[str] = mapped_column(String(20), default="none")  # none, pending, completed, failed

    # Summary and action items (JSON)
    summary: Mapped[str | None] = mapped_column(Text, nullable=True)
    action_items_json: Mapped[str | None] = mapped_column(Text, nullable=True)

    # Pre-meeting brief
    brief: Mapped[str | None] = mapped_column(Text, nullable=True)
    brief_generated_at: Mapped[datetime | None] = mapped_column(DateTime(timezone=True), nullable=True)

    __table_args__ = (
        Index("ix_meetings_detected_at", "detected_at"),
        Index("ix_meetings_calendar_event", "calendar_event_id"),
    )

Import all models in the db/models.py file to ensure they're registered with SQLAlchemy:
Add at end of db/models.py:
from jarvis_server.calendar.models import CalendarEvent, Meeting, SyncState  # noqa: F401
  </action>
  <verify>
python -c "
from jarvis_server.calendar.models import CalendarEvent, Meeting, SyncState
print(f'CalendarEvent table: {CalendarEvent.__tablename__}')
print(f'Meeting table: {Meeting.__tablename__}')
print(f'SyncState table: {SyncState.__tablename__}')
"
  </verify>
  <done>CalendarEvent, Meeting, and SyncState models created and importable</done>
</task>

<task type="auto">
  <name>Task 3: Create OAuth module and calendar API endpoints</name>
  <files>
    server/src/jarvis_server/calendar/oauth.py
    server/src/jarvis_server/api/calendar.py
    server/src/jarvis_server/main.py
  </files>
  <action>
Create OAuth module for Google Calendar authentication.

calendar/oauth.py:
- SCOPES = ["https://www.googleapis.com/auth/calendar.readonly"] (read-only for v1)
- TOKEN_PATH = Path(os.getenv("JARVIS_DATA_DIR", "/data")) / "calendar" / "token.json"
- CREDS_PATH = Path(os.getenv("JARVIS_DATA_DIR", "/data")) / "calendar" / "credentials.json"

Functions:
1. async def get_calendar_service() -> Resource:
   - Load token from TOKEN_PATH if exists
   - Check if valid, refresh if expired
   - If no valid token, raise CalendarAuthRequired exception
   - Return build('calendar', 'v3', credentials=creds)

2. async def start_oauth_flow(port: int = 8090) -> str:
   - Verify CREDS_PATH exists (user must provide credentials.json)
   - Create InstalledAppFlow from client secrets
   - Run local server auth flow on specified port
   - Save token to TOKEN_PATH
   - Return "Authentication successful"

3. def is_authenticated() -> bool:
   - Check if TOKEN_PATH exists and token is valid

Custom exception:
class CalendarAuthRequired(Exception):
    """Raised when calendar OAuth is needed."""
    pass

api/calendar.py:
- Create APIRouter with prefix="/api/calendar" and tags=["calendar"]

Endpoints:
1. GET /api/calendar/auth/status
   - Returns {"authenticated": bool, "needs_credentials": bool}
   - Check if credentials.json exists and if token is valid

2. POST /api/calendar/auth/start
   - Initiates OAuth flow
   - Returns {"status": "auth_started", "message": "Complete auth in browser"}
   - This is for server-side OAuth (user runs on same machine as server)

3. GET /api/calendar/events/upcoming
   - Requires authentication
   - Returns next 10 events from primary calendar
   - Uses list_upcoming_events pattern from research

Update main.py:
- Import and include calendar router: from jarvis_server.api.calendar import router as calendar_router
- app.include_router(calendar_router)
  </action>
  <verify>
python -c "
from jarvis_server.calendar.oauth import is_authenticated, CalendarAuthRequired
from jarvis_server.api.calendar import router
print(f'OAuth module loaded, is_authenticated: {is_authenticated()}')
print(f'Calendar router prefix: {router.prefix}')
print(f'Routes: {[r.path for r in router.routes]}')
"
  </verify>
  <done>OAuth module and calendar API endpoints created and registered</done>
</task>

</tasks>

<verification>
1. pip install -e server/ includes google-api-python-client
2. python -c "from jarvis_server.calendar.models import CalendarEvent, Meeting" works
3. python -c "from jarvis_server.calendar.oauth import get_calendar_service" works
4. python -c "from jarvis_server.api.calendar import router" works
5. Server starts: cd server && python -m jarvis_server.main (briefly, Ctrl+C)
</verification>

<success_criteria>
- Google API dependencies installed
- CalendarEvent, Meeting, SyncState models created
- OAuth flow module ready (token persistence, refresh)
- Calendar API endpoints: /auth/status, /auth/start, /events/upcoming
- Router included in main.py
</success_criteria>

<output>
After completion, create `.planning/phases/04-calendar-meeting-intelligence/04-01-SUMMARY.md`
</output>
