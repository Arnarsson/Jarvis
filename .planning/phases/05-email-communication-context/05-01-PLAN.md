---
phase: 05-email-communication-context
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/jarvis_server/email/__init__.py
  - server/src/jarvis_server/email/oauth.py
  - server/src/jarvis_server/email/models.py
  - server/src/jarvis_server/db/models.py
  - server/src/jarvis_server/api/email.py
autonomous: true

must_haves:
  truths:
    - "User can initiate Gmail OAuth flow from API endpoint"
    - "OAuth tokens are stored securely and can be refreshed"
    - "EmailMessage model exists in database"
  artifacts:
    - path: "server/src/jarvis_server/email/oauth.py"
      provides: "OAuth2 flow with token persistence for Gmail"
      contains: "InstalledAppFlow"
    - path: "server/src/jarvis_server/email/models.py"
      provides: "EmailMessage and EmailSyncState SQLAlchemy models"
      contains: "class EmailMessage"
    - path: "server/src/jarvis_server/api/email.py"
      provides: "OAuth initiation and email list endpoints"
      contains: "@router.get"
  key_links:
    - from: "server/src/jarvis_server/email/oauth.py"
      to: "google-auth-oauthlib"
      via: "InstalledAppFlow import"
      pattern: "from google_auth_oauthlib.flow import InstalledAppFlow"
---

<objective>
Create Gmail OAuth foundation and database schema for email messages

Purpose: Establish the authentication infrastructure for Gmail API access and the database models needed to store email messages. This mirrors the calendar OAuth pattern but for Gmail read access.

Output: Working OAuth flow, EmailMessage database model, API endpoints for auth
</objective>

<execution_context>
@/home/sven/.claude/get-shit-done/workflows/execute-plan.md
@/home/sven/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@server/src/jarvis_server/calendar/oauth.py
@server/src/jarvis_server/calendar/models.py
@server/src/jarvis_server/db/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create email models (EmailMessage, EmailSyncState)</name>
  <files>
    server/src/jarvis_server/email/__init__.py
    server/src/jarvis_server/email/models.py
  </files>
  <action>
Create server/src/jarvis_server/email/ directory with models.

email/__init__.py: Empty package marker

email/models.py: SQLAlchemy models for email data

class EmailSyncState(Base):
    """Stores history ID for incremental Gmail sync."""
    __tablename__ = "email_sync_states"

    id: Mapped[str] = mapped_column(String(50), primary_key=True)  # e.g., "gmail_primary"
    history_id: Mapped[str] = mapped_column(String(50), nullable=False)  # Gmail history ID
    updated_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now())

class EmailMessage(Base):
    """Gmail message synced to Jarvis."""
    __tablename__ = "email_messages"

    id: Mapped[str] = mapped_column(String(36), primary_key=True, default=lambda: str(uuid4()))
    gmail_message_id: Mapped[str] = mapped_column(String(100), unique=True, nullable=False)
    thread_id: Mapped[str] = mapped_column(String(100), nullable=False)

    # Message details
    subject: Mapped[str | None] = mapped_column(String(500), nullable=True)
    from_address: Mapped[str | None] = mapped_column(String(200), nullable=True)
    from_name: Mapped[str | None] = mapped_column(String(200), nullable=True)
    to_addresses: Mapped[str | None] = mapped_column(Text, nullable=True)  # JSON array
    cc_addresses: Mapped[str | None] = mapped_column(Text, nullable=True)  # JSON array

    # Content
    snippet: Mapped[str | None] = mapped_column(Text, nullable=True)  # Gmail's snippet
    body_text: Mapped[str | None] = mapped_column(Text, nullable=True)  # Plain text body

    # Timing
    date_sent: Mapped[datetime] = mapped_column(DateTime(timezone=True), nullable=False)
    date_received: Mapped[datetime | None] = mapped_column(DateTime(timezone=True), nullable=True)

    # Labels/flags
    labels_json: Mapped[str | None] = mapped_column(Text, nullable=True)  # JSON array of label IDs
    is_unread: Mapped[bool] = mapped_column(default=False)
    is_important: Mapped[bool] = mapped_column(default=False)

    # Processing status
    processing_status: Mapped[str] = mapped_column(String(20), default="pending")  # pending, processed, failed
    processed_at: Mapped[datetime | None] = mapped_column(DateTime(timezone=True), nullable=True)

    # Sync metadata
    synced_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), server_default=func.now())

    __table_args__ = (
        Index("ix_email_messages_date_sent", "date_sent"),
        Index("ix_email_messages_gmail_id", "gmail_message_id"),
        Index("ix_email_messages_from", "from_address"),
        Index("ix_email_messages_thread", "thread_id"),
    )

Import all models in the db/models.py file to ensure they're registered with SQLAlchemy:
Add at end of db/models.py:
from jarvis_server.email.models import EmailMessage, EmailSyncState  # noqa: F401
  </action>
  <verify>
python -c "
from jarvis_server.email.models import EmailMessage, EmailSyncState
print(f'EmailMessage table: {EmailMessage.__tablename__}')
print(f'EmailSyncState table: {EmailSyncState.__tablename__}')
"
  </verify>
  <done>EmailMessage and EmailSyncState models created and importable</done>
</task>

<task type="auto">
  <name>Task 2: Create OAuth module for Gmail</name>
  <files>server/src/jarvis_server/email/oauth.py</files>
  <action>
Create OAuth module for Gmail authentication following the calendar OAuth pattern.

email/oauth.py:
- SCOPES = ["https://www.googleapis.com/auth/gmail.readonly"] (read-only)
- TOKEN_PATH = Path(os.getenv("JARVIS_DATA_DIR", "/data")) / "email" / "token.json"
- CREDS_PATH = Path(os.getenv("JARVIS_DATA_DIR", "/data")) / "email" / "credentials.json"

Note: Can share the same credentials.json as calendar if using the same Google Cloud project.

Functions:
1. async def get_gmail_service() -> Resource:
   - Load token from TOKEN_PATH if exists
   - Check if valid, refresh if expired
   - If no valid token, raise GmailAuthRequired exception
   - Return build('gmail', 'v1', credentials=creds)

2. async def start_oauth_flow(port: int = 8091) -> str:
   - Verify CREDS_PATH exists (user must provide credentials.json)
   - Create InstalledAppFlow from client secrets with SCOPES
   - Run local server auth flow on specified port (different from calendar)
   - Save token to TOKEN_PATH
   - Return "Authentication successful"

3. def is_authenticated() -> bool:
   - Check if TOKEN_PATH exists and token is valid

Custom exception:
class GmailAuthRequired(Exception):
    """Raised when Gmail OAuth is needed."""
    pass
  </action>
  <verify>
python -c "
from jarvis_server.email.oauth import is_authenticated, GmailAuthRequired
print(f'Gmail OAuth module loaded, is_authenticated: {is_authenticated()}')
"
  </verify>
  <done>Gmail OAuth module created with token persistence</done>
</task>

<task type="auto">
  <name>Task 3: Create email API endpoints</name>
  <files>
    server/src/jarvis_server/api/email.py
    server/src/jarvis_server/main.py
  </files>
  <action>
Create API endpoints for email auth and message listing.

api/email.py:
- Create APIRouter with prefix="/api/email" and tags=["email"]

Endpoints:
1. GET /api/email/auth/status
   - Returns {"authenticated": bool, "needs_credentials": bool}
   - Check if credentials.json exists and if token is valid

2. POST /api/email/auth/start
   - Initiates OAuth flow
   - Returns {"status": "auth_started", "message": "Complete auth in browser"}

3. GET /api/email/messages
   - Query params: limit (default 20), from_address (optional filter)
   - Returns list of EmailMessage objects from database
   - Ordered by date_sent descending

4. GET /api/email/messages/{message_id}
   - Returns full email message including body

Update main.py:
- Import and include email router: from jarvis_server.api.email import router as email_router
- app.include_router(email_router)
  </action>
  <verify>
python -c "
from jarvis_server.api.email import router
print(f'Email router prefix: {router.prefix}')
print(f'Routes: {[r.path for r in router.routes]}')
"
  </verify>
  <done>Email API endpoints created and registered</done>
</task>

</tasks>

<verification>
1. python -c "from jarvis_server.email.models import EmailMessage" works
2. python -c "from jarvis_server.email.oauth import get_gmail_service" works
3. python -c "from jarvis_server.api.email import router" works
4. Server starts: cd server && python -m jarvis_server.main (briefly, Ctrl+C)
</verification>

<success_criteria>
- EmailMessage, EmailSyncState models created
- Gmail OAuth flow module ready (token persistence, refresh)
- Email API endpoints: /auth/status, /auth/start, /messages, /messages/{id}
- Router included in main.py
</success_criteria>

<output>
After completion, create `.planning/phases/05-email-communication-context/05-01-SUMMARY.md`
</output>
