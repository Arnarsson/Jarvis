---
phase: 05-email-communication-context
plan: 02
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - server/src/jarvis_server/email/sync.py
  - server/src/jarvis_server/api/email.py
autonomous: true

must_haves:
  truths:
    - "Email sync fetches messages from Gmail using history API"
    - "Incremental sync uses history ID to get only new messages"
    - "Messages are stored with full metadata and body text"
  artifacts:
    - path: "server/src/jarvis_server/email/sync.py"
      provides: "Gmail incremental sync service"
      contains: "sync_emails"
  key_links:
    - from: "server/src/jarvis_server/email/sync.py"
      to: "Gmail API"
      via: "users.history.list"
      pattern: "history().list"
---

<objective>
Implement email incremental sync service using Gmail History API

Purpose: Sync emails from Gmail to local database using incremental sync (history API) for efficiency. Only fetch new/changed messages after initial sync.

Output: Working email sync that imports messages with metadata and body text
</objective>

<execution_context>
@/home/sven/.claude/get-shit-done/workflows/execute-plan.md
@/home/sven/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-email-communication-context/05-01-SUMMARY.md
@server/src/jarvis_server/calendar/sync.py
@server/src/jarvis_server/email/oauth.py
@server/src/jarvis_server/email/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create email sync service</name>
  <files>server/src/jarvis_server/email/sync.py</files>
  <action>
Create sync service for Gmail messages.

email/sync.py:

Key functions:

1. async def sync_emails(db: AsyncSession, full_sync: bool = False) -> dict:
   """Main sync entry point.

   Returns: {"created": int, "updated": int, "deleted": int}
   """
   - Get Gmail service
   - If full_sync or no history_id: do initial_sync
   - Else: do incremental_sync using history API
   - Update EmailSyncState with new history_id

2. async def initial_sync(service, db: AsyncSession, days_back: int = 30) -> tuple[int, str]:
   """Full sync of recent messages.

   Returns: (message_count, history_id)
   """
   - Query messages.list with q="newer_than:{days_back}d"
   - Fetch each message with format="full"
   - Parse headers (Subject, From, To, Cc, Date)
   - Extract body text (prefer text/plain, fallback to text/html stripped)
   - Store in EmailMessage model
   - Get current history ID from profile
   - Return count and history_id

3. async def incremental_sync(service, db: AsyncSession, start_history_id: str) -> tuple[int, int, int, str]:
   """Incremental sync using Gmail History API.

   Returns: (created, updated, deleted, new_history_id)
   """
   - Call users.history.list(startHistoryId=start_history_id, historyTypes=['messageAdded', 'messageDeleted'])
   - For messageAdded: fetch and store new messages
   - For messageDeleted: mark messages as deleted (or soft delete)
   - Return counts and new history_id

4. def parse_email_headers(headers: list[dict]) -> dict:
   """Parse Gmail message headers into dict."""
   - Extract Subject, From, To, Cc, Date
   - Parse From into (name, address) parts

5. def extract_body_text(payload: dict) -> str:
   """Extract plain text body from message payload."""
   - Handle multipart messages
   - Prefer text/plain
   - Fallback to text/html with BeautifulSoup stripping
   - Handle base64 decoding

6. async def get_message_full(service, message_id: str) -> dict:
   """Fetch full message details."""
   - service.users().messages().get(userId='me', id=message_id, format='full')
  </action>
  <verify>
python -c "
from jarvis_server.email.sync import sync_emails, parse_email_headers, extract_body_text
print('Email sync module loaded')
print('Functions: sync_emails, parse_email_headers, extract_body_text')
"
  </verify>
  <done>Email sync service created with history API support</done>
</task>

<task type="auto">
  <name>Task 2: Add sync endpoint to email API</name>
  <files>server/src/jarvis_server/api/email.py</files>
  <action>
Add sync trigger endpoint.

Add to api/email.py:

POST /api/email/sync
- Query param: full_sync (bool, default False)
- Calls sync_emails(db, full_sync)
- Returns {"status": "completed", "created": N, "updated": N, "deleted": N}

GET /api/email/sync/status
- Returns sync state info: last_sync, history_id, message_count
  </action>
  <verify>
curl -X POST http://localhost:8000/api/email/sync 2>/dev/null || echo "Endpoint added (server not running)"
python -c "
from jarvis_server.api.email import router
routes = [r.path for r in router.routes]
assert '/sync' in str(routes) or 'sync' in str(routes), 'Sync endpoint missing'
print('Sync endpoint added')
"
  </verify>
  <done>Email sync endpoint added to API</done>
</task>

<task type="auto">
  <name>Task 3: Add BeautifulSoup dependency for HTML parsing</name>
  <files>server/pyproject.toml</files>
  <action>
Add beautifulsoup4 dependency for HTML body text extraction.

In server/pyproject.toml dependencies:
"beautifulsoup4>=4.12.0",

This is used to strip HTML tags when email body is only available as HTML.
  </action>
  <verify>
pip install beautifulsoup4 && python -c "from bs4 import BeautifulSoup; print('BeautifulSoup installed')"
  </verify>
  <done>BeautifulSoup dependency added</done>
</task>

</tasks>

<verification>
1. python -c "from jarvis_server.email.sync import sync_emails" works
2. Email sync endpoint exists in router
3. Server starts without errors
4. After OAuth: POST /api/email/sync returns message counts
</verification>

<success_criteria>
- sync_emails fetches messages from Gmail
- Initial sync gets recent messages (last 30 days)
- Incremental sync uses history API for efficiency
- Messages stored with subject, from, body text
- Sync endpoint triggers sync and returns counts
</success_criteria>

<output>
After completion, create `.planning/phases/05-email-communication-context/05-02-SUMMARY.md`
</output>
