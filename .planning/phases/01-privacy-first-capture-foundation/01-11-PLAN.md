---
phase: 01-privacy-first-capture-foundation
plan: 11
type: execute
wave: 4
depends_on: ["01-04"]
files_modified:
  - agent/src/jarvis/logging.py
  - server/src/jarvis_server/logging.py
  - server/src/jarvis_server/privacy/__init__.py
  - server/src/jarvis_server/privacy/detector.py
autonomous: true

must_haves:
  truths:
    - "All agent actions are logged in JSON format"
    - "All server actions are logged with request context"
    - "PII detector identifies credit cards, SSNs, API keys"
  artifacts:
    - path: "agent/src/jarvis/logging.py"
      provides: "Agent structured logging"
      contains: "def get_logger"
    - path: "server/src/jarvis_server/logging.py"
      provides: "Server structured logging"
      contains: "def get_logger"
    - path: "server/src/jarvis_server/privacy/detector.py"
      provides: "PII detection with Presidio"
      contains: "class PIIDetector"
  key_links:
    - from: "server/src/jarvis_server/privacy/detector.py"
      to: "presidio_analyzer"
      via: "PII analysis"
      pattern: "AnalyzerEngine"
    - from: "server/src/jarvis_server/logging.py"
      to: "structlog"
      via: "Structured logging"
      pattern: "structlog"
---

<objective>
Implement security foundations: audit logging and PII detection.

Purpose: Establishes security primitives for SEC-01 (sensitive content filtering) and SEC-02 (audit logging) that protect user privacy and enable security monitoring.
Output: Structured JSON logging for both agent and server, plus Presidio-based PII detection.
</objective>

<execution_context>
@/home/sven/.claude/get-shit-done/workflows/execute-plan.md
@/home/sven/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-privacy-first-capture-foundation/01-RESEARCH.md
@.planning/phases/01-privacy-first-capture-foundation/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Structured logging for agent and server</name>
  <files>
    agent/src/jarvis/logging.py
    server/src/jarvis_server/logging.py
  </files>
  <action>
Implement structured JSON logging:

1. Create `agent/src/jarvis/logging.py`:
   - Use python-json-logger for simplicity (already in deps)

   - Function `setup_logging(level: str = "INFO", log_file: Path | None = None)`:
     - Configures root logger with JSON formatter
     - If log_file: adds rotating file handler
     - Console handler with JSON output

   - Function `get_logger(name: str) -> logging.Logger`:
     - Returns named logger
     - Adds default context (agent_id, version)

   - JSON log format should include:
     - timestamp (ISO format)
     - level
     - logger name
     - message
     - Extra fields passed via extra={}

   - Audit-relevant events to log:
     - capture_taken: monitor_index, reason, file_size
     - capture_skipped: reason (idle, excluded, no_change)
     - upload_success: capture_id, server_response_time
     - upload_failed: capture_id, error, attempt_count
     - state_change: old_state, new_state
     - config_change: key, old_value, new_value

2. Create `server/src/jarvis_server/logging.py`:
   - Use structlog for richer server logging

   - Function `setup_logging(level: str = "INFO")`:
     - Configures structlog with JSON renderer
     - Adds timestamp, log level processors
     - Integrates with standard library logging

   - Function `get_logger(name: str = None) -> structlog.BoundLogger`:
     - Returns bound logger with optional name

   - Middleware `LoggingMiddleware` for FastAPI:
     - Logs request start: method, path, client_ip
     - Logs request complete: status_code, duration_ms
     - Adds request_id to log context

   - Audit-relevant events:
     - capture_received: capture_id, file_size, client_ip
     - capture_stored: capture_id, filepath
     - pii_detected: capture_id, pii_types, count
     - api_error: endpoint, error_type, message

Use ISO 8601 timestamps. Do NOT include sensitive data (passwords, tokens) in logs.
  </action>
  <verify>
cd /home/sven/Documents/jarvis/agent && python -c "
from jarvis.logging import setup_logging, get_logger
setup_logging('DEBUG')
log = get_logger('test')
log.info('Test event', extra={'capture_id': 'abc123', 'file_size': 50000})
"

cd /home/sven/Documents/jarvis/server && python -c "
from jarvis_server.logging import setup_logging, get_logger
setup_logging('DEBUG')
log = get_logger('test')
log.info('Test event', capture_id='abc123', file_size=50000)
"
  </verify>
  <done>Both agent and server produce JSON-formatted logs with contextual fields</done>
</task>

<task type="auto">
  <name>Task 2: PII detection with Presidio</name>
  <files>
    server/src/jarvis_server/privacy/__init__.py
    server/src/jarvis_server/privacy/detector.py
  </files>
  <action>
Implement PII detection using Microsoft Presidio:

1. Create `server/src/jarvis_server/privacy/detector.py`:
   - Class `PIIDetector`:
     - `__init__(self, score_threshold: float = 0.5)`:
       - Initializes AnalyzerEngine (lazy - on first use to avoid startup delay)
       - Configures entity types to detect
       - Stores threshold for filtering low-confidence results

     - `_ensure_initialized(self)`:
       - Lazy initialization of AnalyzerEngine
       - Called before first analysis

     - `def detect(self, text: str) -> list[PIIResult]`:
       - Analyzes text for PII
       - Returns list of PIIResult with: entity_type, start, end, score, text_snippet

     - `def has_pii(self, text: str) -> bool`:
       - Quick check if any PII detected
       - Returns True/False

     - `def anonymize(self, text: str) -> str`:
       - Replaces detected PII with placeholders
       - E.g., "Call me at 555-1234" -> "Call me at <PHONE_NUMBER>"

     - `def get_pii_summary(self, text: str) -> dict`:
       - Returns {"has_pii": bool, "types": ["CREDIT_CARD", ...], "count": N}

   - Dataclass `PIIResult`:
     - entity_type: str
     - start: int
     - end: int
     - score: float
     - text_snippet: str (masked - first/last char only)

   - Entity types to detect (SEC-01):
     - CREDIT_CARD
     - US_SSN
     - PHONE_NUMBER
     - EMAIL_ADDRESS
     - IP_ADDRESS
     - CRYPTO (wallet addresses)
     - Custom pattern for API keys: regex for common formats (sk_live_*, ghp_*, etc.)

2. Create `server/src/jarvis_server/privacy/__init__.py` exporting PIIDetector

Add presidio-analyzer to server pyproject.toml if not present.
Note: Presidio can be slow on first load due to NLP models.
  </action>
  <verify>
cd /home/sven/Documents/jarvis/server && python -c "
from jarvis_server.privacy import PIIDetector

detector = PIIDetector()

# Test various PII types
test_texts = [
    'My credit card is 4111-1111-1111-1111',
    'SSN: 123-45-6789',
    'Call me at 555-123-4567',
    'Email: test@example.com',
    'API key: sk_live_abc123xyz',
    'No PII here, just normal text about the weather.'
]

for text in test_texts:
    result = detector.get_pii_summary(text)
    print(f'Text: \"{text[:40]}...\" -> {result}')
"
  </verify>
  <done>PIIDetector identifies credit cards, SSNs, phone numbers, emails, API key patterns</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Agent logs capture events in JSON format
2. Server logs requests with duration and status
3. PII detector identifies common sensitive data types
4. Logs do not contain actual PII values (masked or excluded)
</verification>

<success_criteria>
- Audit logging captures all system actions (SEC-02)
- PII detection identifies passwords, credit cards, API keys (SEC-01)
- Log format is JSON for easy parsing and monitoring
- No sensitive data in log output
</success_criteria>

<output>
After completion, create `.planning/phases/01-privacy-first-capture-foundation/01-11-SUMMARY.md`
</output>
