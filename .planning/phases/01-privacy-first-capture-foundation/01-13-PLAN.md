---
phase: 01-privacy-first-capture-foundation
plan: 13
type: execute
wave: 6
depends_on: ["01-08", "01-09", "01-10", "01-12"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "User can start the desktop agent and see screenshots being captured"
    - "User can pause/resume capture at any time via system tray or CLI"
    - "Sensitive applications are excluded from capture"
    - "Desktop performance is not noticeably degraded"
    - "Captures are uploaded to server over Tailscale"
---

<objective>
Verify end-to-end functionality of the capture system.

Purpose: Validates that all Phase 1 components work together to meet the success criteria defined in the roadmap.
Output: Verified working system ready for Phase 2.
</objective>

<execution_context>
@/home/sven/.claude/get-shit-done/workflows/execute-plan.md
@/home/sven/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-privacy-first-capture-foundation/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Automated integration tests</name>
  <files>
    agent/tests/test_integration.py
    server/tests/test_integration.py
  </files>
  <action>
Create integration tests that verify component interaction:

1. Create `agent/tests/test_integration.py`:
   - Test: capture_loop_respects_exclusions
     - Start CaptureLoop with mock exclusion filter
     - Verify captures are skipped when excluded app "active"

   - Test: capture_loop_respects_idle
     - Start CaptureLoop with mock idle detector
     - Verify captures pause when idle

   - Test: change_detection_skips_duplicate
     - Capture same static image twice
     - Verify second capture skipped

   - Test: upload_queue_persists
     - Enqueue item, close queue, reopen
     - Verify item still pending

2. Create `server/tests/test_integration.py`:
   - Test: capture_upload_stores_file
     - POST multipart upload to /api/captures
     - Verify file exists on disk
     - Verify metadata in database

   - Test: health_check_reports_status
     - GET /health/
     - Verify response includes component status

   - Test: pii_detection_flags_sensitive
     - Submit capture with OCR text containing credit card
     - Verify PII detected and logged

Run with pytest. Use fixtures for database/storage setup/teardown.
  </action>
  <verify>
cd /home/sven/Documents/jarvis/agent && python -m pytest tests/test_integration.py -v 2>&1 | tail -20
cd /home/sven/Documents/jarvis/server && python -m pytest tests/test_integration.py -v 2>&1 | tail -20
  </verify>
  <done>Integration tests pass, verifying component interaction</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Manual system verification</name>
  <what-built>
Complete Jarvis capture system with:
- Desktop agent with screenshot capture, change detection, idle detection
- System tray showing status (green/yellow/red)
- CLI commands: jarvis capture start, jarvis status, jarvis config
- Server with capture upload API, PostgreSQL, Qdrant
- Docker Compose deployment
  </what-built>
  <how-to-verify>
1. **Start Server (if testing with server)**
   ```bash
   cd server && docker compose up -d
   # Wait for services to start
   docker compose logs -f jarvis-server
   ```

2. **Start Agent**
   ```bash
   cd agent && pip install -e .
   jarvis capture start
   ```

3. **Verify Tray Icon**
   - Look for green tray icon in system tray
   - Right-click should show menu with Pause/Resume, Quit

4. **Verify Captures**
   - Check ~/.local/share/jarvis/captures/ for JPEG files
   - Files should appear every ~15 seconds (or on screen change)

5. **Test Pause/Resume**
   - Click "Pause" in tray menu
   - Icon should turn yellow
   - No new captures should appear
   - Click "Resume" - icon green, captures resume

6. **Test Exclusions**
   - Open a password manager (1Password, Bitwarden, etc.)
   - Bring it to foreground
   - Verify no captures taken while it's active
   - Switch to another app - captures should resume

7. **Test CLI**
   ```bash
   jarvis status
   jarvis status --json
   jarvis config show
   ```

8. **Verify Performance**
   - Agent should use minimal CPU when idle
   - No noticeable system slowdown

9. **Verify Upload (if server running)**
   ```bash
   curl http://localhost:8000/health/
   # Check server logs for received captures
   docker compose logs jarvis-server | grep capture_received
   ```
  </how-to-verify>
  <resume-signal>Type "approved" if all verifications pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
This plan IS the verification for Phase 1. Success means:
1. Automated integration tests pass
2. Manual verification confirms all user-facing functionality works
</verification>

<success_criteria>
From ROADMAP.md Phase 1 Success Criteria:
1. User can start the desktop agent and see screenshots being captured at configurable intervals
2. User can pause/resume capture at any time via system tray or CLI
3. Sensitive applications (password managers, banking) are excluded from capture
4. Desktop performance is not noticeably degraded while agent runs
5. Captures are uploaded to server over encrypted Tailscale connection and stored securely
</success_criteria>

<output>
After completion, create `.planning/phases/01-privacy-first-capture-foundation/01-13-SUMMARY.md`
</output>
