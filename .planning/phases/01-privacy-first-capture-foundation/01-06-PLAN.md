---
phase: 01-privacy-first-capture-foundation
plan: 06
type: execute
wave: 3
depends_on: ["01-04"]
files_modified:
  - server/src/jarvis_server/api/__init__.py
  - server/src/jarvis_server/api/captures.py
  - server/src/jarvis_server/api/health.py
  - server/src/jarvis_server/main.py
autonomous: true

must_haves:
  truths:
    - "POST /api/captures accepts multipart upload and stores capture"
    - "GET /health returns server status"
    - "Server starts with uvicorn and accepts requests"
  artifacts:
    - path: "server/src/jarvis_server/api/captures.py"
      provides: "Capture upload endpoint"
      exports: ["router"]
    - path: "server/src/jarvis_server/api/health.py"
      provides: "Health check endpoints"
      exports: ["router"]
    - path: "server/src/jarvis_server/main.py"
      provides: "FastAPI application entry point"
      contains: "app = FastAPI"
  key_links:
    - from: "server/src/jarvis_server/api/captures.py"
      to: "server/src/jarvis_server/storage/filesystem.py"
      via: "FileStorage dependency"
      pattern: "FileStorage"
    - from: "server/src/jarvis_server/api/captures.py"
      to: "server/src/jarvis_server/db/session.py"
      via: "Database session dependency"
      pattern: "get_db"
---

<objective>
Implement FastAPI server with capture upload endpoint.

Purpose: Provides the server-side API that receives captures from agents, stores files to disk, and records metadata in the database (CAPT-06).
Output: FastAPI application with capture upload, health check, and proper dependency injection.
</objective>

<execution_context>
@/home/sven/.claude/get-shit-done/workflows/execute-plan.md
@/home/sven/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-privacy-first-capture-foundation/01-RESEARCH.md
@.planning/phases/01-privacy-first-capture-foundation/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Capture upload API endpoint</name>
  <files>
    server/src/jarvis_server/api/__init__.py
    server/src/jarvis_server/api/captures.py
  </files>
  <action>
Implement capture upload endpoint with FastAPI:

1. Create `server/src/jarvis_server/api/captures.py`:
   - Create APIRouter with prefix="/api/captures", tags=["captures"]

   - Dependency `get_storage() -> FileStorage`:
     - Returns FileStorage instance configured from settings
     - Use functools.lru_cache or lifespan pattern

   - Schema `CaptureMetadata(BaseModel)`:
     - timestamp: datetime
     - monitor_index: int = 0
     - width: int
     - height: int
     - agent_id: str | None = None

   - Schema `CaptureResponse(BaseModel)`:
     - id: str
     - status: str
     - filepath: str

   - Endpoint `POST /` (upload_capture):
     - Parameters:
       - file: UploadFile = File(...)
       - metadata: str = Form(...) # JSON string
       - db: AsyncSession = Depends(get_db)
       - storage: FileStorage = Depends(get_storage)
     - Parse metadata JSON to CaptureMetadata
     - Generate UUID for capture_id
     - Read file content
     - Store file via storage.store()
     - Create Capture model instance
     - Add to session and commit
     - Return CaptureResponse

   - Endpoint `GET /{capture_id}`:
     - Returns capture metadata (not file) by ID
     - 404 if not found

   - Handle errors with proper HTTPException codes

2. Create `server/src/jarvis_server/api/__init__.py` exporting router

Use structlog for request logging. Validate file is JPEG/image type.
  </action>
  <verify>
cd /home/sven/Documents/jarvis/server && python -c "
from jarvis_server.api.captures import router
print(f'Routes: {[r.path for r in router.routes]}')
"
  </verify>
  <done>Capture router has POST / and GET /{capture_id} endpoints</done>
</task>

<task type="auto">
  <name>Task 2: Health check and main application</name>
  <files>
    server/src/jarvis_server/api/health.py
    server/src/jarvis_server/main.py
  </files>
  <action>
Implement health endpoint and main FastAPI app:

1. Create `server/src/jarvis_server/api/health.py`:
   - Create APIRouter with prefix="/health", tags=["health"]

   - Schema `HealthResponse(BaseModel)`:
     - status: str = "healthy"
     - version: str
     - database: str = "unknown"
     - storage: str = "unknown"

   - Endpoint `GET /`:
     - Check database connectivity (simple SELECT 1)
     - Check storage path exists and is writable
     - Return HealthResponse with status of each component
     - Return 200 even if components unhealthy (for monitoring that checks body)

   - Endpoint `GET /ready`:
     - Returns 200 only if all components healthy
     - Returns 503 if any component unhealthy

2. Create `server/src/jarvis_server/main.py`:
   - Create FastAPI app with title="Jarvis Server", version from __version__
   - Configure CORS middleware with settings.cors_origins
   - Include capture router
   - Include health router
   - Add lifespan context manager:
     - On startup: Log server starting, ensure storage directory exists
     - On shutdown: Log server stopping

   - Function `run()`:
     - Calls uvicorn.run with host="0.0.0.0", port=8000
     - This is the CLI entry point

3. Add startup log with structlog showing config (mask sensitive values)
  </action>
  <verify>
cd /home/sven/Documents/jarvis/server && timeout 5 python -c "
import asyncio
from jarvis_server.main import app
from httpx import AsyncClient, ASGITransport

async def test():
    async with AsyncClient(transport=ASGITransport(app=app), base_url='http://test') as client:
        resp = await client.get('/health/')
        print(f'Health: {resp.status_code} - {resp.json()}')

asyncio.run(test())
" || echo "Test completed (timeout expected)"
  </verify>
  <done>FastAPI app starts, health endpoint returns status, capture router is mounted</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `POST /api/captures` accepts file upload with metadata
2. `GET /health/` returns server status
3. `GET /health/ready` returns 503 if DB not connected (expected without real DB)
4. CORS is configured for agent connections
</verification>

<success_criteria>
- Capture upload endpoint stores files and metadata (covers CAPT-06)
- Health endpoints enable monitoring
- FastAPI app properly configured with routers and middleware
- Async operations throughout for performance
</success_criteria>

<output>
After completion, create `.planning/phases/01-privacy-first-capture-foundation/01-06-SUMMARY.md`
</output>
