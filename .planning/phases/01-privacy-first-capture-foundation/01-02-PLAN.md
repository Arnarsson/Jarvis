---
phase: 01-privacy-first-capture-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - server/pyproject.toml
  - server/src/jarvis_server/__init__.py
  - server/src/jarvis_server/config.py
  - server/src/jarvis_server/db/__init__.py
  - server/src/jarvis_server/db/session.py
  - server/README.md
autonomous: true

must_haves:
  truths:
    - "Server project can be installed with pip install -e ."
    - "Database session factory creates async sessions"
    - "Configuration loads from environment variables"
  artifacts:
    - path: "server/pyproject.toml"
      provides: "Package definition with all dependencies"
      contains: "fastapi"
    - path: "server/src/jarvis_server/config.py"
      provides: "Server settings"
      contains: "class Settings"
    - path: "server/src/jarvis_server/db/session.py"
      provides: "Async SQLAlchemy session factory"
      contains: "async_sessionmaker"
  key_links:
    - from: "server/src/jarvis_server/db/session.py"
      to: "sqlalchemy.ext.asyncio"
      via: "Async engine creation"
      pattern: "create_async_engine"
---

<objective>
Create the foundational project structure for the Jarvis server.

Purpose: Establishes the FastAPI server package layout, dependency management, configuration, and async database session factory that all server modules will build upon.
Output: Installable Python package with FastAPI, SQLAlchemy 2.0 async session setup, and pydantic-settings configuration.
</objective>

<execution_context>
@/home/sven/.claude/get-shit-done/workflows/execute-plan.md
@/home/sven/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-privacy-first-capture-foundation/01-RESEARCH.md
@.planning/phases/01-privacy-first-capture-foundation/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create server project structure</name>
  <files>
    server/pyproject.toml
    server/src/jarvis_server/__init__.py
    server/README.md
  </files>
  <action>
Create the server project directory with modern Python packaging:

1. Create `server/pyproject.toml` with:
   - Project name: jarvis-server
   - Python 3.11+ requirement
   - Dependencies from research: fastapi, uvicorn[standard], sqlalchemy[asyncio], asyncpg, qdrant-client, structlog, pydantic-settings, alembic, python-multipart, aiofiles
   - Entry point: `jarvis-server = jarvis_server.main:run`
   - Development dependencies: pytest, pytest-asyncio, httpx (for testing), ruff

2. Create `server/src/jarvis_server/__init__.py` with version string `__version__ = "0.1.0"`

3. Create `server/README.md` with brief description and setup instructions

Use src layout (src/jarvis_server/) for proper package isolation.
  </action>
  <verify>
cd /home/sven/Documents/jarvis/server && pip install -e . 2>&1 | grep -E "(Successfully|error)"
  </verify>
  <done>Package installs without errors</done>
</task>

<task type="auto">
  <name>Task 2: Configuration and database session factory</name>
  <files>
    server/src/jarvis_server/config.py
    server/src/jarvis_server/db/__init__.py
    server/src/jarvis_server/db/session.py
  </files>
  <action>
Create configuration and async database session setup:

1. Create `server/src/jarvis_server/config.py`:
   - Class `Settings(BaseSettings)` with fields:
     - database_url: str = "postgresql+asyncpg://jarvis:jarvis@localhost:5432/jarvis"
     - qdrant_host: str = "localhost"
     - qdrant_port: int = 6333
     - storage_path: Path = Path("/data/captures")
     - log_level: str = "INFO"
     - cors_origins: list[str] = ["*"]
   - model_config with env_prefix="JARVIS_"
   - Function `get_settings()` with functools.lru_cache

2. Create `server/src/jarvis_server/db/session.py`:
   - Import create_async_engine, async_sessionmaker from sqlalchemy.ext.asyncio
   - Create engine from settings.database_url with echo=False for production
   - Create AsyncSessionLocal = async_sessionmaker(engine, expire_on_commit=False)
   - Create async generator `get_db()` that yields sessions for FastAPI dependency injection
   - Use `async with AsyncSessionLocal() as session` pattern

3. Create `server/src/jarvis_server/db/__init__.py` exporting get_db and AsyncSessionLocal

IMPORTANT: Use SQLAlchemy 2.0 async patterns (create_async_engine, async_sessionmaker), NOT the deprecated 1.x patterns.
  </action>
  <verify>
cd /home/sven/Documents/jarvis/server && python -c "
from jarvis_server.config import get_settings
from jarvis_server.db.session import AsyncSessionLocal
print(f'DB URL: {get_settings().database_url}')
print(f'Session factory: {AsyncSessionLocal}')
"
  </verify>
  <done>Settings load from environment, async session factory is properly configured</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `cd server && pip install -e .` succeeds
2. `python -c "from jarvis_server.config import get_settings; print(get_settings())"` shows settings
3. `python -c "from jarvis_server.db import get_db, AsyncSessionLocal; print(type(AsyncSessionLocal))"` confirms async session
</verification>

<success_criteria>
- Server package is pip-installable in editable mode
- Settings class loads from environment variables with JARVIS_ prefix
- Database URL uses asyncpg driver (postgresql+asyncpg://)
- Session factory uses SQLAlchemy 2.0 async patterns
</success_criteria>

<output>
After completion, create `.planning/phases/01-privacy-first-capture-foundation/01-02-SUMMARY.md`
</output>
