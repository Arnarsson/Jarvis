---
phase: 01-privacy-first-capture-foundation
plan: 10
type: execute
wave: 4
depends_on: ["01-08"]
files_modified:
  - agent/src/jarvis/cli.py
  - agent/src/jarvis/cli_commands/__init__.py
  - agent/src/jarvis/cli_commands/capture.py
  - agent/src/jarvis/cli_commands/config.py
  - agent/src/jarvis/cli_commands/status.py
autonomous: true

must_haves:
  truths:
    - "jarvis capture start launches the agent"
    - "jarvis status shows current capture state"
    - "jarvis config exclusions runs interactive wizard"
    - "CLI output is human-readable by default, JSON with --json flag"
  artifacts:
    - path: "agent/src/jarvis/cli.py"
      provides: "Main CLI entry point"
      contains: "app = typer.Typer"
    - path: "agent/src/jarvis/cli_commands/capture.py"
      provides: "Capture subcommands"
      contains: "def start"
    - path: "agent/src/jarvis/cli_commands/config.py"
      provides: "Config subcommands with exclusion wizard"
      contains: "def exclusions"
  key_links:
    - from: "agent/src/jarvis/cli.py"
      to: "typer"
      via: "CLI framework"
      pattern: "typer\\.Typer"
    - from: "agent/src/jarvis/cli_commands/capture.py"
      to: "agent/src/jarvis/engine/orchestrator.py"
      via: "Start orchestrator"
      pattern: "CaptureOrchestrator"
---

<objective>
Implement CLI interface for the desktop agent.

Purpose: Provides command-line control of the agent with subcommand structure, fulfilling CAPT-04 user control requirement alongside the tray interface.
Output: Typer CLI with capture, status, and config commands including interactive exclusion wizard.
</objective>

<execution_context>
@/home/sven/.claude/get-shit-done/workflows/execute-plan.md
@/home/sven/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-privacy-first-capture-foundation/01-RESEARCH.md
@.planning/phases/01-privacy-first-capture-foundation/01-CONTEXT.md
@.planning/phases/01-privacy-first-capture-foundation/01-08-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Main CLI structure with capture and status commands</name>
  <files>
    agent/src/jarvis/cli.py
    agent/src/jarvis/cli_commands/__init__.py
    agent/src/jarvis/cli_commands/capture.py
    agent/src/jarvis/cli_commands/status.py
  </files>
  <action>
Implement CLI structure using Typer:

1. Create `agent/src/jarvis/cli_commands/capture.py`:
   - Create capture_app = typer.Typer(help="Capture management")

   - Command `start`:
     - Options: --interval (int), --no-tray (bool), --background/-b (bool)
     - If --background: daemonize process
     - Else: run in foreground
     - Creates CaptureOrchestrator and optionally JarvisTray
     - Runs until interrupted (Ctrl+C)
     - Human output: "Starting Jarvis capture agent..."
     - JSON output: {"status": "started", "pid": N}

   - Command `stop`:
     - Finds running agent process and sends SIGTERM
     - Human output: "Stopping Jarvis agent..."
     - JSON output: {"status": "stopped"}

   - Command `pause`:
     - Sends pause signal to running agent (via file/socket IPC)
     - For now: simple implementation with PID file

   - Command `resume`:
     - Sends resume signal to running agent

2. Create `agent/src/jarvis/cli_commands/status.py`:
   - Create status_app = typer.Typer() (or just a command function)

   - Command `status` (registered on main app, not subcommand):
     - Options: --json/-j (bool)
     - Checks if agent is running
     - Gets status from running agent (IPC) or shows "not running"
     - Human output:
       ```
       Jarvis Agent Status
       -------------------
       State: Active (capturing)
       Captures today: 150
       Queue: 3 pending uploads
       Last capture: 2 minutes ago
       ```
     - JSON output:
       ```json
       {"running": true, "state": "active", "captures_today": 150, "queue_size": 3}
       ```

3. Create `agent/src/jarvis/cli.py`:
   - Create main app = typer.Typer(help="Jarvis screen capture agent")
   - Add capture_app as subcommand: app.add_typer(capture_app, name="capture")
   - Add status command directly to app
   - Add version callback: --version shows jarvis-agent version
   - Entry point function for pyproject.toml

4. Create `agent/src/jarvis/cli_commands/__init__.py` with exports

CLI style should match user preference: `jarvis capture start`, `jarvis status`
  </action>
  <verify>
cd /home/sven/Documents/jarvis/agent && python -m jarvis.cli --help && python -m jarvis.cli capture --help && python -m jarvis.cli status --help
  </verify>
  <done>CLI shows help for main app, capture subcommand, and status command</done>
</task>

<task type="auto">
  <name>Task 2: Config commands with exclusion wizard</name>
  <files>
    agent/src/jarvis/cli_commands/config.py
  </files>
  <action>
Implement config commands including interactive exclusion wizard:

1. Create `agent/src/jarvis/cli_commands/config.py`:
   - Create config_app = typer.Typer(help="Configuration management")

   - Command `show`:
     - Options: --json/-j (bool)
     - Shows current configuration
     - Human output: formatted key-value pairs
     - JSON output: full settings dict

   - Command `set`:
     - Arguments: key (str), value (str)
     - Updates configuration value
     - Example: `jarvis config set capture_interval 30`

   - Command `exclusions`:
     - Subcommand `list`: shows current exclusions
     - Subcommand `add`: adds app/title pattern
     - Subcommand `remove`: removes pattern
     - Subcommand `wizard`: interactive selection

   - Function `_run_exclusion_wizard()`:
     - Uses pywinctl to list all open windows
     - Presents numbered list of running applications
     - User selects which to exclude (comma-separated numbers)
     - Adds selected apps to exclusions.yaml
     - Confirms additions

     Interactive output:
     ```
     Running Applications:
     1. Firefox (5 windows)
     2. VS Code (2 windows)
     3. 1Password (1 window) [already excluded]
     4. Terminal (3 windows)

     Enter numbers to exclude (comma-separated), or 'q' to quit: 2,4

     Added exclusions:
     - code (VS Code)
     - gnome-terminal (Terminal)

     Exclusions saved to ~/.config/jarvis/exclusions.yaml
     ```

2. Register config_app in cli.py: app.add_typer(config_app, name="config")

Use typer.prompt() and typer.confirm() for interactive input.
Use rich.table or simple formatting for lists.
  </action>
  <verify>
cd /home/sven/Documents/jarvis/agent && python -m jarvis.cli config --help && python -m jarvis.cli config show
  </verify>
  <done>Config commands work, exclusion wizard can list running apps</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `jarvis --help` shows all commands
2. `jarvis capture start` launches agent (exits gracefully if dependencies missing)
3. `jarvis status` shows agent state
4. `jarvis status --json` outputs valid JSON
5. `jarvis config exclusions wizard` lists running applications
</verification>

<success_criteria>
- CLI uses subcommand style as specified in CONTEXT.md (CAPT-04)
- Human-readable output by default, --json for machine-readable
- Interactive exclusion wizard helps users configure exclusions (CAPT-03)
- All commands have help text
</success_criteria>

<output>
After completion, create `.planning/phases/01-privacy-first-capture-foundation/01-10-SUMMARY.md`
</output>
