---
phase: 01-privacy-first-capture-foundation
plan: 09
type: execute
wave: 4
depends_on: ["01-08"]
files_modified:
  - agent/src/jarvis/tray.py
  - agent/src/jarvis/icons/__init__.py
autonomous: true

must_haves:
  truths:
    - "System tray icon appears with correct status color"
    - "Right-click menu shows Pause/Resume, Settings, Quit options"
    - "Icon color changes when capture state changes"
  artifacts:
    - path: "agent/src/jarvis/tray.py"
      provides: "System tray interface"
      contains: "class JarvisTray"
    - path: "agent/src/jarvis/icons/__init__.py"
      provides: "Icon generation utilities"
      contains: "def create_icon"
  key_links:
    - from: "agent/src/jarvis/tray.py"
      to: "pystray"
      via: "System tray integration"
      pattern: "pystray\\.Icon"
    - from: "agent/src/jarvis/tray.py"
      to: "agent/src/jarvis/engine/orchestrator.py"
      via: "Orchestrator control"
      pattern: "CaptureOrchestrator"
---

<objective>
Implement system tray interface for the desktop agent.

Purpose: Provides visual status indication and quick access to common actions (pause/resume, settings) via system tray, fulfilling CAPT-04 user control requirement.
Output: pystray-based system tray with status colors and context menu.
</objective>

<execution_context>
@/home/sven/.claude/get-shit-done/workflows/execute-plan.md
@/home/sven/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-privacy-first-capture-foundation/01-RESEARCH.md
@.planning/phases/01-privacy-first-capture-foundation/01-CONTEXT.md
@.planning/phases/01-privacy-first-capture-foundation/01-08-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Icon generation utilities</name>
  <files>
    agent/src/jarvis/icons/__init__.py
  </files>
  <action>
Create icon generation for status indicators:

1. Create `agent/src/jarvis/icons/__init__.py`:
   - Enum `TrayStatus`:
     - ACTIVE = "active"      # Green - capturing
     - PAUSED = "paused"      # Yellow - user paused
     - IDLE = "idle"          # Yellow - auto-paused due to idle
     - EXCLUDED = "excluded"  # Yellow - excluded app active
     - ERROR = "error"        # Red - error state
     - SYNCING = "syncing"    # Blue - uploading

   - STATUS_COLORS dict mapping TrayStatus to RGB tuples:
     - ACTIVE: (76, 175, 80)      # Material green
     - PAUSED: (255, 193, 7)      # Material amber
     - IDLE: (255, 193, 7)        # Same as paused
     - EXCLUDED: (255, 193, 7)    # Same as paused
     - ERROR: (244, 67, 54)       # Material red
     - SYNCING: (33, 150, 243)    # Material blue

   - Function `create_status_icon(status: TrayStatus, size: int = 64) -> Image.Image`:
     - Creates a circular icon with status color
     - Use PIL ImageDraw for circle
     - Add subtle border/shadow for visibility
     - Return PIL Image

   - Function `create_icon_with_indicator(status: TrayStatus, base_icon: Image.Image | None = None) -> Image.Image`:
     - If base_icon provided, overlay status dot in corner
     - Else create simple status circle
     - For now, just use simple circles (base_icon support for later branding)

Icons should be simple, clear, and visible in both light and dark system themes.
  </action>
  <verify>
cd /home/sven/Documents/jarvis/agent && python -c "
from jarvis.icons import TrayStatus, create_status_icon

for status in TrayStatus:
    icon = create_status_icon(status)
    print(f'{status.name}: {icon.size}, mode={icon.mode}')
"
  </verify>
  <done>Status icons generate correctly for all states with appropriate colors</done>
</task>

<task type="auto">
  <name>Task 2: System tray with pystray</name>
  <files>
    agent/src/jarvis/tray.py
  </files>
  <action>
Implement system tray using pystray:

1. Create `agent/src/jarvis/tray.py`:
   - Class `JarvisTray`:
     - `__init__(self, orchestrator: CaptureOrchestrator)`:
       - Stores orchestrator reference
       - Initializes current status = TrayStatus.ACTIVE
       - Creates pystray.Icon (initially None, created in run())
       - Registers orchestrator state change callback

     - `def _create_menu(self) -> pystray.Menu`:
       - Dynamic menu based on current state:
         - If ACTIVE: "Pause Capture"
         - If PAUSED/IDLE/EXCLUDED: "Resume Capture"
         - Separator
         - "Open Settings..." (placeholder for now)
         - "View Recent Captures..." (placeholder)
         - "Force Sync Now"
         - "View Logs..." (placeholder)
         - Separator
         - Status line: "Queue: N pending"
         - Separator
         - "Quit Jarvis"

     - `def _on_toggle_capture(self, icon, item)`:
       - Toggles pause/resume on orchestrator
       - Updates icon

     - `def _on_force_sync(self, icon, item)`:
       - Calls orchestrator.force_sync()

     - `def _on_quit(self, icon, item)`:
       - Calls orchestrator.stop() (async - need to handle)
       - Calls icon.stop()

     - `def _update_status(self, new_status: TrayStatus)`:
       - Updates self.status
       - Updates icon image
       - Updates menu (icon.update_menu())

     - `def _on_orchestrator_state_change(self, state: CaptureState)`:
       - Maps CaptureState to TrayStatus
       - Calls _update_status

     - `def run(self)`:
       - Creates pystray.Icon with name="jarvis", icon, title, menu
       - Calls icon.run() (blocking - runs on main thread)

     - `def run_detached(self) -> threading.Thread`:
       - Runs tray in separate thread
       - Returns thread for joining
       - Use icon.run_detached() if available, else thread wrapper

IMPORTANT: pystray.run() blocks. For integration with async orchestrator:
- Run tray in main thread
- Run orchestrator in separate thread/asyncio event loop
- Or use run_detached pattern

Reference research patterns for menu structure from 01-CONTEXT.md.
  </action>
  <verify>
cd /home/sven/Documents/jarvis/agent && python -c "
from jarvis.tray import JarvisTray
from jarvis.icons import TrayStatus

# Can't fully test without display, but verify imports and structure
print('JarvisTray imported successfully')
print(f'Menu items will include: Pause/Resume, Settings, Force Sync, Quit')
"
  </verify>
  <done>JarvisTray creates proper menu structure, icon updates on state change</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Status icons render for all states (green, yellow, red)
2. Tray menu has all required items from CONTEXT.md
3. Pause/Resume toggles orchestrator state
4. Icon color updates when state changes
</verification>

<success_criteria>
- System tray shows capture status visually (CAPT-04)
- User can pause/resume via tray menu (CAPT-04)
- Status colors match specification: green=active, yellow=paused, red=error
- Menu includes all items from user requirements
</success_criteria>

<output>
After completion, create `.planning/phases/01-privacy-first-capture-foundation/01-09-SUMMARY.md`
</output>
