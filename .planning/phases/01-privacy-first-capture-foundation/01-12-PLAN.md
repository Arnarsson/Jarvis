---
phase: 01-privacy-first-capture-foundation
plan: 12
type: execute
wave: 5
depends_on: ["01-06", "01-11"]
files_modified:
  - server/Dockerfile
  - server/docker-compose.yml
  - server/.env.example
  - docs/DEPLOYMENT.md
autonomous: true

must_haves:
  truths:
    - "docker-compose up starts all services"
    - "PostgreSQL container with persistent volume"
    - "Qdrant container accessible on port 6333"
    - "Server accessible only via Tailscale IP"
  artifacts:
    - path: "server/docker-compose.yml"
      provides: "Service orchestration"
      contains: "services:"
    - path: "server/Dockerfile"
      provides: "Server container image"
      contains: "FROM python"
    - path: "docs/DEPLOYMENT.md"
      provides: "Deployment instructions"
      contains: "Tailscale"
  key_links:
    - from: "server/docker-compose.yml"
      to: "PostgreSQL"
      via: "Database service"
      pattern: "postgres:"
    - from: "server/docker-compose.yml"
      to: "Qdrant"
      via: "Vector database service"
      pattern: "qdrant"
---

<objective>
Create Docker infrastructure for server deployment.

Purpose: Enables deployment of the Jarvis server on Hetzner with Docker Compose, fulfilling INFRA-01 through INFRA-05 requirements.
Output: Production-ready Docker Compose setup with PostgreSQL, Qdrant, and server containers.
</objective>

<execution_context>
@/home/sven/.claude/get-shit-done/workflows/execute-plan.md
@/home/sven/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-privacy-first-capture-foundation/01-RESEARCH.md
@.planning/phases/01-privacy-first-capture-foundation/01-CONTEXT.md
@.planning/phases/01-privacy-first-capture-foundation/01-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dockerfile and docker-compose.yml</name>
  <files>
    server/Dockerfile
    server/docker-compose.yml
    server/.env.example
  </files>
  <action>
Create Docker configuration for server deployment:

1. Create `server/Dockerfile`:
   - Use python:3.11-slim as base
   - Set working directory /app
   - Copy pyproject.toml and install dependencies
   - Copy source code
   - Expose port 8000
   - Run with uvicorn: CMD ["uvicorn", "jarvis_server.main:app", "--host", "0.0.0.0", "--port", "8000"]
   - Use non-root user for security
   - Add healthcheck

2. Create `server/docker-compose.yml`:
   Services:

   a. `jarvis-server`:
      - Build from Dockerfile
      - Ports: "127.0.0.1:8000:8000" (localhost only - Tailscale will forward)
      - Environment from .env file
      - Depends on: postgres, qdrant
      - Volumes: captures:/data/captures
      - Restart: unless-stopped
      - Healthcheck: curl http://localhost:8000/health/ready

   b. `postgres`:
      - Image: postgres:15-alpine
      - Environment: POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_DB
      - Volumes: postgres_data:/var/lib/postgresql/data
      - Ports: "127.0.0.1:5432:5432" (localhost only)
      - Healthcheck: pg_isready

   c. `qdrant`:
      - Image: qdrant/qdrant:latest
      - Volumes: qdrant_data:/qdrant/storage
      - Ports: "127.0.0.1:6333:6333" (localhost only)

   Volumes:
   - postgres_data
   - qdrant_data
   - captures

   Networks:
   - jarvis-net (internal)

3. Create `server/.env.example`:
   ```
   # Database
   POSTGRES_USER=jarvis
   POSTGRES_PASSWORD=changeme
   POSTGRES_DB=jarvis

   # Server
   JARVIS_DATABASE_URL=postgresql+asyncpg://jarvis:changeme@postgres:5432/jarvis
   JARVIS_QDRANT_HOST=qdrant
   JARVIS_QDRANT_PORT=6333
   JARVIS_STORAGE_PATH=/data/captures
   JARVIS_LOG_LEVEL=INFO
   ```

IMPORTANT: All ports bound to 127.0.0.1 only. Access is via Tailscale IP (SEC-04).
  </action>
  <verify>
cd /home/sven/Documents/jarvis/server && docker compose config 2>&1 | head -50
  </verify>
  <done>Docker Compose validates successfully, all services defined</done>
</task>

<task type="auto">
  <name>Task 2: Deployment documentation</name>
  <files>
    docs/DEPLOYMENT.md
  </files>
  <action>
Create deployment documentation:

1. Create `docs/DEPLOYMENT.md`:

   # Jarvis Server Deployment

   ## Prerequisites
   - Hetzner server (or similar) with Docker installed
   - Tailscale installed and configured
   - Domain/IP accessible via Tailscale

   ## Initial Setup

   ### 1. Install Tailscale on Server
   ```bash
   curl -fsSL https://tailscale.com/install.sh | sh
   tailscale up
   ```
   Note the Tailscale IP (e.g., 100.x.y.z)

   ### 2. Clone and Configure
   ```bash
   git clone <repo>
   cd jarvis/server
   cp .env.example .env
   # Edit .env with secure passwords
   ```

   ### 3. Start Services
   ```bash
   docker compose up -d
   ```

   ### 4. Run Database Migrations
   ```bash
   docker compose exec jarvis-server alembic upgrade head
   ```

   ### 5. Verify Deployment
   ```bash
   curl http://localhost:8000/health/
   ```

   ## Security Configuration

   ### Tailscale-Only Access (SEC-03, SEC-04)
   The server binds to 127.0.0.1 only. Access via Tailscale IP.

   On client machines:
   ```bash
   export JARVIS_SERVER_URL=http://100.x.y.z:8000
   ```

   ### Firewall Rules
   ```bash
   # Allow only Tailscale interface
   ufw allow in on tailscale0
   ufw deny 8000  # Block direct access
   ```

   ## Monitoring

   Health endpoints:
   - `/health/` - Basic status
   - `/health/ready` - Full readiness check

   ## Backup

   Docker volumes to backup:
   - postgres_data: Database
   - qdrant_data: Vector embeddings
   - captures: Screenshot files

   ## Troubleshooting

   Check logs:
   ```bash
   docker compose logs -f jarvis-server
   docker compose logs -f postgres
   ```

Document should cover INFRA-01 (Hetzner), INFRA-02 (Tailscale), SEC-03, SEC-04.
  </action>
  <verify>
test -f /home/sven/Documents/jarvis/docs/DEPLOYMENT.md && head -30 /home/sven/Documents/jarvis/docs/DEPLOYMENT.md
  </verify>
  <done>Deployment documentation covers setup, security, and monitoring</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `docker compose config` validates without errors
2. Services bind only to localhost (not 0.0.0.0 on public ports)
3. Documentation covers Tailscale setup for secure access
4. All required volumes defined for persistence
</verification>

<success_criteria>
- Docker Compose orchestrates all services (INFRA-01)
- Tailscale setup documented for encrypted transport (INFRA-02, SEC-03)
- Server accessible only via Tailscale (SEC-04)
- PostgreSQL and Qdrant containers configured (INFRA-01)
</success_criteria>

<output>
After completion, create `.planning/phases/01-privacy-first-capture-foundation/01-12-SUMMARY.md`
</output>
